<!DOCTYPE html><html lang=zh-CN><head><meta charset=UTF-8><meta content="ie=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=UTF-8" http-equiv=Content-Type><meta content="width=device-width,initial-scale=1,user-scalable=no" name=viewport><title>断点续传与个人网盘系统的前后端设计 | boycot</title><meta content="Astro, 分享, 博客" name=keywords><meta content=功能设计登录鉴权：进入系统必须先登录，未登录无法访问到后端接口与网盘的静态资源上传：断点续传、文件秒传文件分享：生成一个随机密钥字符串与一个资源访问地址，输入密钥验证成功即可访问到该资源，密钥会在一定时间内过期回收站：删除后的文件默认先保留在回收站，7天后自动删除文件操作:新建文件夹、重命名、移动、 name=description><meta content="telephone=no, email=no, date=no, address=no" name=format-detection><meta content=断点续传与个人网盘系统的前后端设计 name=title><meta content=https://astro-blog.boycot.top name=site><meta content=boycot name=author><meta content="Astro v5.13.10" name=generator><meta content="index, follow, max-image-preview:large" name=robots><meta content="https://bing.img.run/rand.php?timestamp=17590259117828jmhj2&type=2" itemprop=image><meta content=boycot property=article:author><meta content=article property=og:type><meta content=boycot property=og:site_name><meta content=断点续传与个人网盘系统的前后端设计 property=og:title><meta content=功能设计登录鉴权：进入系统必须先登录，未登录无法访问到后端接口与网盘的静态资源上传：断点续传、文件秒传文件分享：生成一个随机密钥字符串与一个资源访问地址，输入密钥验证成功即可访问到该资源，密钥会在一定时间内过期回收站：删除后的文件默认先保留在回收站，7天后自动删除文件操作:新建文件夹、重命名、移动、 property=og:description><meta content=https://astro-blog.boycot.top/article/%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0%E4%B8%8E%E4%B8%AA%E4%BA%BA%E7%BD%91%E7%9B%98%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%89%8D%E5%90%8E%E7%AB%AF%E8%AE%BE%E8%AE%A1 property=og:url><meta content="https://bing.img.run/rand.php?timestamp=17590259117828jmhj2&type=2" property=og:image><meta content=zh_CN property=og:locale><meta content=summary_large_image name=twitter:card><meta content=boycot name=twitter:site><meta content=boycot name=twitter:creator><meta content=断点续传与个人网盘系统的前后端设计 name=twitter:title><meta content=功能设计登录鉴权：进入系统必须先登录，未登录无法访问到后端接口与网盘的静态资源上传：断点续传、文件秒传文件分享：生成一个随机密钥字符串与一个资源访问地址，输入密钥验证成功即可访问到该资源，密钥会在一定时间内过期回收站：删除后的文件默认先保留在回收站，7天后自动删除文件操作:新建文件夹、重命名、移动、 name=twitter:description><meta content=https://astro-blog.boycot.top/article/%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0%E4%B8%8E%E4%B8%AA%E4%BA%BA%E7%BD%91%E7%9B%98%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%89%8D%E5%90%8E%E7%AB%AF%E8%AE%BE%E8%AE%A1 name=twitter:url><meta content="https://bing.img.run/rand.php?timestamp=17590259117828jmhj2&type=2" name=twitter:image><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://astro-blog.boycot.top/article/%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0%E4%B8%8E%E4%B8%AA%E4%BA%BA%E7%BD%91%E7%9B%98%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%89%8D%E5%90%8E%E7%AB%AF%E8%AE%BE%E8%AE%A1"},"headline":"断点续传与个人网盘系统的前后端设计","description":"功能设计登录鉴权：进入系统必须先登录，未登录无法访问到后端接口与网盘的静态资源上传：断点续传、文件秒传文件分享：生成一个随机密钥字符串与一个资源访问地址，输入密钥验证成功即可访问到该资源，密钥会在一定时间内过期回收站：删除后的文件默认先保留在回收站，7天后自动删除文件操作:新建文件夹、重命名、移动、","image":["https://bing.img.run/rand.php?timestamp=17590259117828jmhj2&type=2"],"datePublished":"2025-09-28T02:18:31.782+08:00","dateModified":"2025-09-28T02:18:31.782+08:00","author":{"@type":"Person","name":"boycot","url":"https://astro-blog.boycot.top"},"publisher":{"@type":"Organization","name":"boycot","logo":{"@type":"ImageObject","url":"https://astro-blog.boycot.top/assets/images/banner/072c12ec85d2d3b5.webp"}},"keywords":"Astro, 分享, 博客"}</script><link href=/sitemap-index.xml rel=sitemap><link href=https://i0.wp.com rel=dns-prefetch><link href=https://cn.cravatar.com rel=dns-prefetch><link href=https://analytics.vvhan.com rel=dns-prefetch><link href=https://vh-api.4ce.cn rel=dns-prefetch><link href=https://registry.npmmirror.com rel=dns-prefetch><link href=https://pagead2.googlesyndication.com rel=dns-prefetch><link href=https://i0.wp.com rel=preconnect><link href=https://cn.cravatar.com rel=preconnect><link href=https://analytics.vvhan.com rel=preconnect><link href=https://vh-api.4ce.cn rel=preconnect><link href=https://registry.npmmirror.com rel=preconnect><link href=https://pagead2.googlesyndication.com rel=preconnect><link href=https://astro-blog.boycot.top/article/%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0%E4%B8%8E%E4%B8%AA%E4%BA%BA%E7%BD%91%E7%9B%98%E7%B3%BB%E7%BB%9F%E7%9A%84%E5%89%8D%E5%90%8E%E7%AB%AF%E8%AE%BE%E8%AE%A1 rel=canonical><link href=/favicon.svg rel=icon type=image/x-icon><script src=/assets/js/vhCaiqi.js defer=defer></script><style>:root{--byt-main-color:#126e82;--byt-font-color:#34495e;--byt-aside-width:318px;--byt-main-radius:0.28rem;--byt-main-max-width:1458px;--byt-main-header-height:28.88rem;--byt-home-banner:url('https://bing.img.run/rand.php') no-repeat center 60%/cover}</style><link href=/static/Layout-BDtqLxc7.css rel=stylesheet><link href=/static/article-_article_-CnDmdB7d.css rel=stylesheet><link href=/static/about-index-2-B2euGUIL.css rel=stylesheet><link href=/static/about-index-1-BItXrbz-.css rel=stylesheet><link href=/static/about-index-1-BPyknviE.css rel=stylesheet><script src=/js/page-4ZBNsjYQ.js type=module></script></head><body><nav class=byt-sidebar><section class=main><div class="byt-sidebar-list user-panel"><h3>boycot</h3></div><div class="byt-sidebar-list byt-link-list"><a href=/links target=_self class=links><svg viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 height=24 width=24 class="icon icon-tabler icons-tabler-outline icon-tabler-friends"><path d="M0 0h24v24H0z" fill=none stroke=none /><path d="M7 5m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"/><path d="M5 22v-5l-1 -1v-4a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v4l-1 1v5"/><path d="M17 5m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"/><path d="M15 22v-4h-2l2 -6a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1l2 6h-2v4"/></svg> 友链 </a><a href=/friends target=_self class=friends><svg viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 height=24 width=24 class="icon icon-tabler icons-tabler-outline icon-tabler-rss"><path d="M0 0h24v24H0z" fill=none stroke=none /><path d="M5 19m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"/><path d="M4 4a16 16 0 0 1 16 16"/><path d="M4 11a9 9 0 0 1 9 9"/></svg> 圈子 </a><a href=/talking target=_self class=talking><svg viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 height=24 width=24 class="icon icon-tabler icons-tabler-outline icon-tabler-live-photo"><path d="M0 0h24v24H0z" fill=none stroke=none /><path d="M12 12m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"/><path d="M12 12m-5 0a5 5 0 1 0 10 0a5 5 0 1 0 -10 0"/><path d="M15.9 20.11l0 .01"/><path d="M19.04 17.61l0 .01"/><path d="M20.77 14l0 .01"/><path d="M20.77 10l0 .01"/><path d="M19.04 6.39l0 .01"/><path d="M15.9 3.89l0 .01"/><path d="M12 3l0 .01"/><path d="M8.1 3.89l0 .01"/><path d="M4.96 6.39l0 .01"/><path d="M3.23 10l0 .01"/><path d="M3.23 14l0 .01"/><path d="M4.96 17.61l0 .01"/><path d="M8.1 20.11l0 .01"/><path d="M12 21l0 .01"/></svg> 动态 </a><a href=/archives target=_self class=archives><svg viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 height=24 width=24><path d="M0 0h24v24H0z" fill=none stroke=none /><path d="M7 3m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z"/><path d="M4.012 7.26a2.005 2.005 0 0 0 -1.012 1.737v10c0 1.1 .9 2 2 2h10c.75 0 1.158 -.385 1.5 -1"/><path d="M11 7h5"/><path d="M11 10h6"/><path d="M11 13h3"/></svg> 时间轴 </a><a href=/message target=_self class=message><svg viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 height=24 width=24 class="icon icon-tabler icons-tabler-outline icon-tabler-message"><path d="M0 0h24v24H0z" fill=none stroke=none /><path d="M8 9h8"/><path d="M8 13h6"/><path d="M18 4a3 3 0 0 1 3 3v8a3 3 0 0 1 -3 3h-5l-5 3v-3h-2a3 3 0 0 1 -3 -3v-8a3 3 0 0 1 3 -3h12z"/></svg> 留言 </a><a href=/about target=_self class=about><svg viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 height=24 width=24 class="icon icon-tabler icons-tabler-outline icon-tabler-brand-linkedin"><path d="M0 0h24v24H0z" fill=none stroke=none /><path d="M8 11v5"/><path d="M8 8v.01"/><path d="M12 16v-5"/><path d="M16 16v-3a2 2 0 1 0 -4 0"/><path d="M3 7a4 4 0 0 1 4 -4h10a4 4 0 0 1 4 4v10a4 4 0 0 1 -4 4h-10a4 4 0 0 1 -4 -4z"/></svg> 关于 </a><a href=https://api-docs.boycot.top/ target=_blank class=https:/api-docs.boycot.top/ ><svg viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 height=24 width=24 class="icon icon-tabler icons-tabler-outline icon-tabler-link"><path d="M0 0h24v24H0z" fill=none stroke=none /><path d="M9 15l6 -6"/><path d="M11 6l.463 -.536a5 5 0 0 1 7.071 7.072l-.534 .464"/><path d="M13 18l-.397 .534a5.068 5.068 0 0 1 -7.127 0a4.972 4.972 0 0 1 0 -7.071l.524 -.463"/></svg> API</a></div></section></nav><header class=byt-header><section class=main><a href=/ class="byt-hover home"><svg viewBox="0 0 256 256" xmlns=http://www.w3.org/2000/svg height=24px width=24px><path d="M216 120a8 8 0 0 0-6.78 3.76A180 180 0 0 1 195.41 143l-17.09-89.93a16 16 0 0 0-25.72-9.55l-.13.1L128 64l-24.47-20.38l-.13-.1a16 16 0 0 0-25.72 9.53L60.59 143a179 179 0 0 1-13.81-19.25A8 8 0 0 0 40 120a40 40 0 0 0 0 80h176a40 40 0 0 0 0-80M93.41 56l24.47 20.4l.12.1a15.92 15.92 0 0 0 20 0l.12-.1L162.59 56l13.68 72H79.73ZM40 184a24 24 0 0 1-4.14-47.64C51.28 159.83 67.73 174.65 82.4 184Zm88 0c-.33 0-25.49-.4-53.86-26.6l2.54-13.4h102.63l2.54 13.35a113.3 113.3 0 0 1-27.35 19c-15.4 7.42-26.44 7.65-26.5 7.65m88 0h-42.4c14.67-9.35 31.12-24.17 46.54-47.64A24 24 0 0 1 216 184" fill=currentColor /></svg> <span>boycot</span></a><nav><a href=/links target=_self class="byt-hover nav-link">友链 <svg viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 height=24 width=24 class="icon icon-tabler icons-tabler-outline icon-tabler-friends"><path d="M0 0h24v24H0z" fill=none stroke=none /><path d="M7 5m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"/><path d="M5 22v-5l-1 -1v-4a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v4l-1 1v5"/><path d="M17 5m-2 0a2 2 0 1 0 4 0a2 2 0 1 0 -4 0"/><path d="M15 22v-4h-2l2 -6a1 1 0 0 1 1 -1h2a1 1 0 0 1 1 1l2 6h-2v4"/></svg> </a><a href=/friends target=_self class="byt-hover nav-link">圈子 <svg viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 height=24 width=24 class="icon icon-tabler icons-tabler-outline icon-tabler-rss"><path d="M0 0h24v24H0z" fill=none stroke=none /><path d="M5 19m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"/><path d="M4 4a16 16 0 0 1 16 16"/><path d="M4 11a9 9 0 0 1 9 9"/></svg> </a><a href=/talking target=_self class="byt-hover nav-link">动态 <svg viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 height=24 width=24 class="icon icon-tabler icons-tabler-outline icon-tabler-live-photo"><path d="M0 0h24v24H0z" fill=none stroke=none /><path d="M12 12m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"/><path d="M12 12m-5 0a5 5 0 1 0 10 0a5 5 0 1 0 -10 0"/><path d="M15.9 20.11l0 .01"/><path d="M19.04 17.61l0 .01"/><path d="M20.77 14l0 .01"/><path d="M20.77 10l0 .01"/><path d="M19.04 6.39l0 .01"/><path d="M15.9 3.89l0 .01"/><path d="M12 3l0 .01"/><path d="M8.1 3.89l0 .01"/><path d="M4.96 6.39l0 .01"/><path d="M3.23 10l0 .01"/><path d="M3.23 14l0 .01"/><path d="M4.96 17.61l0 .01"/><path d="M8.1 20.11l0 .01"/><path d="M12 21l0 .01"/></svg> </a><a href=/archives target=_self class="byt-hover nav-link">时间轴 <svg viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 height=24 width=24><path d="M0 0h24v24H0z" fill=none stroke=none /><path d="M7 3m0 2.667a2.667 2.667 0 0 1 2.667 -2.667h8.666a2.667 2.667 0 0 1 2.667 2.667v8.666a2.667 2.667 0 0 1 -2.667 2.667h-8.666a2.667 2.667 0 0 1 -2.667 -2.667z"/><path d="M4.012 7.26a2.005 2.005 0 0 0 -1.012 1.737v10c0 1.1 .9 2 2 2h10c.75 0 1.158 -.385 1.5 -1"/><path d="M11 7h5"/><path d="M11 10h6"/><path d="M11 13h3"/></svg> </a><a href=/message target=_self class="byt-hover nav-link">留言 <svg viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 height=24 width=24 class="icon icon-tabler icons-tabler-outline icon-tabler-message"><path d="M0 0h24v24H0z" fill=none stroke=none /><path d="M8 9h8"/><path d="M8 13h6"/><path d="M18 4a3 3 0 0 1 3 3v8a3 3 0 0 1 -3 3h-5l-5 3v-3h-2a3 3 0 0 1 -3 -3v-8a3 3 0 0 1 3 -3h12z"/></svg> </a><a href=/about target=_self class="byt-hover nav-link">关于 <svg viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 height=24 width=24 class="icon icon-tabler icons-tabler-outline icon-tabler-brand-linkedin"><path d="M0 0h24v24H0z" fill=none stroke=none /><path d="M8 11v5"/><path d="M8 8v.01"/><path d="M12 16v-5"/><path d="M16 16v-3a2 2 0 1 0 -4 0"/><path d="M3 7a4 4 0 0 1 4 -4h10a4 4 0 0 1 4 4v10a4 4 0 0 1 -4 4h-10a4 4 0 0 1 -4 -4z"/></svg> </a><a href=https://api-docs.boycot.top/ target=_blank class="byt-hover nav-link">API <svg viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 height=24 width=24 class="icon icon-tabler icons-tabler-outline icon-tabler-link"><path d="M0 0h24v24H0z" fill=none stroke=none /><path d="M9 15l6 -6"/><path d="M11 6l.463 -.536a5 5 0 0 1 7.071 7.072l-.534 .464"/><path d="M13 18l-.397 .534a5.068 5.068 0 0 1 -7.127 0a4.972 4.972 0 0 1 0 -7.071l.524 -.463"/></svg> </a><span class="byt-hover nav-link search-btn"><svg viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2><path d="M0 0h24v24H0z" fill=none stroke=none></path><path d="M10 10m-7 0a7 7 0 1 0 14 0a7 7 0 1 0 -14 0"></path><path d="M21 21l-6 -6"></path></svg> 搜索</span> <span class="byt-hover nav-link menu-btn"><svg viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 height=24 width=24><path d="M0 0h24v24H0z" fill=none stroke=none></path><path d="M4 6h16"></path><path d="M7 12h13"></path><path d="M10 18h10"></path></svg></span></nav><section class=byt-search><main><div class=search-input><svg viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg><path d="m19.6 21l-6.3-6.3q-.75.6-1.725.95T9.5 16q-2.725 0-4.612-1.888T3 9.5t1.888-4.612T9.5 3t4.613 1.888T16 9.5q0 1.1-.35 2.075T14.7 13.3l6.3 6.3zM9.5 14q1.875 0 3.188-1.312T14 9.5t-1.312-3.187T9.5 5T6.313 6.313T5 9.5t1.313 3.188T9.5 14" fill=#B4B4B4></path></svg> <input placeholder=搜索文章 type=text></div><section class=byt-search-list><em></em></section></main></section></section></header><main class=main><div class=header-main><div class=avatar><img alt=avatar src=/assets/images/lazy-loading.webp data-byt-lz-src=https://boycot2015.github.io/picx-images-hosting/avatar/avatar.7pnvyzg2f.webp></div><h3 class=auther>boycot</h3><p class=desc></p></div><section class=main-inner style=padding-top:.88rem;flex-direction:row><section class=main-inner-content><article class="byt-animation byt-animation-init byt-article-main"><header><h1>断点续传与个人网盘系统的前后端设计</h1><div class=article-meta><span class=article-meta-item><svg viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2><path d="M0 0h24v24H0z" fill=none stroke=none></path><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path><path d="M12 12h3.5"></path><path d="M12 7v5"></path></svg> <time>2020-05-05 凌晨</time> <span class=count><strong>3115</strong>字</span> <span class=time><strong>15.6</strong>分钟</span> </span><a href="/categories/undefined" class=article-meta-item><svg viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 height=24 width=24><path d="M0 0h24v24H0z" fill=none stroke=none></path><path d="M4 6h16"></path><path d="M7 12h13"></path><path d="M10 18h10"></path></svg> <span></span></a></div></header><main><h2 id=功能设计>功能设计</h2><ol><li>登录鉴权：进入系统必须先登录，未登录无法访问到后端接口与网盘的静态资源</li><li>上传：断点续传、文件秒传</li><li>文件分享：生成一个随机密钥字符串与一个资源访问地址，输入密钥验证成功即可访问到该资源，密钥会在一定时间内过期</li><li>回收站：删除后的文件默认先保留在回收站，7 天后自动删除</li><li>文件操作: 新建文件夹、重命名、移动、删除、批量删除</li></ol><h2 id=技术选型>技术选型</h2><ul><li>前端：使用 Vue 构建，使用 ElementUI 构建 UI，使用 vue-simple-uploader 插件实现上传的断点续传、文件秒传功能。</li><li>后端：使用 Koa 实现，直接使用 Koa 搭建静态资源服务器（即个人网盘资源目录），加入静态资源鉴权，使用原生 Nodejs 处理文件管理与上传功能。</li></ul><h2 id=问题与思考>问题与思考</h2><h3 id=q是否需要使用数据库将文件信息保存到数据库中>Q：是否需要使用数据库，将文件信息保存到数据库中？</h3><p>原则上，文件的增删查改都将使用原生 nodejs 进行操作，这些都不需要使用到数据库。但是原生 nodejs 并不能直接读取到文件的 MD5 值，在断点续传与秒传功能中就无法通过传来的 MD5 标识跟本地的文件进行匹配。所以还是需要建立一个含文件 MD5、文件路径等信息的数据表记录本地文件的 MD5。</p><h3 id=q若使用了数据库记录文件-md5-信息怎么保证数据表的数据与本地物理存储是同步的>Q：若使用了数据库记录文件 MD5 信息，怎么保证数据表的数据与本地物理存储是同步的？</h3><p>如果进行文件操作并不是通过该文件管理系统，而是直接在 windows 上进入到网盘目录进行文件增删改，这时我们的应用是无法监听到文件的变更的，数据表数据并不会更新。这样就会出现我把某个文件删除了，但是数据表仍然记录了该文件是已经上传的情况。</p><p>原本是想采用使用定时器定时对本地文件与数据表进行数据同步，但是发现这样在后期文件多或嵌套深的情况下性能会很差，这种方式并不合适。</p><p>由于这些信息只是在文件断点续传与秒传功能中需要用到，后面采用的方案为：直接在预探请求中先判断数据库信息是否与本地物理存储相符，如果不相符则认为本地已不存在，需要重新上传。（原则上是不推荐直接使用 windows 进入目录进行文件操作，而是都通过这个文件管理系统进行文件操作）</p><h3 id=q-同一个文件但存在于网盘不同目录下同时在不同目录删除该文件回收站中是否会冲突>Q: 同一个文件，但存在于网盘不同目录下，同时在不同目录删除该文件，回收站中是否会冲突？</h3><p>删除文件时，使用原文件名+时间(yyyy-MM-dd HH:mm</p><section></section>)进行重命名后再移动文件到回收站。同时需要往数据库记录文件删除的信息，删除前的文件路径与删除时间等，以便实现文件还原与回收站定时清理的功能。<p></p><h3 id=q文件夹并无-md5-值删除文件夹如何确保可以还原>Q：文件夹并无 MD5 值，删除文件夹如何确保可以还原？</h3><p>删除文件夹与删除文件属于同样的操作，也是通过文件夹名+时间重命名后移动到回收站目录。但是数据库中需要使用一个新的数据表记录文件夹的删除信息。</p><h2 id=实现>实现</h2><h3 id=文件鉴权>文件鉴权</h3><p>登录时保留 session, 然后使用一个中间件鉴权，如果没有 session 则不允许访问系统除登录接口外的其他任何请求，包括静态资源。使用 koa-static 构建静态资源服务器，并将 defer 属性设置为 true，让它允许通过鉴权中间件。</p><section class=byt-code-box><span class=byt-code-copy></span><pre class="astro-code github-light" data-language=js style=background-color:#fff;color:#24292e;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d>// ...</span></span>
<span class=line><span style=color:#24292e>app.</span><span style=color:#6f42c1>use</span><span style=color:#24292e>(</span><span style=color:#d73a49>async</span><span style=color:#24292e> (</span><span style=color:#e36209>ctx</span><span style=color:#24292e>, </span><span style=color:#e36209>next</span><span style=color:#24292e>) </span><span style=color:#d73a49>=></span><span style=color:#24292e> {</span></span>
<span class=line><span style=color:#d73a49>  if</span><span style=color:#24292e> (ctx.url.</span><span style=color:#6f42c1>includes</span><span style=color:#24292e>(</span><span style=color:#032f62>"/storage"</span><span style=color:#24292e>) </span><span style=color:#d73a49>&#x26;&#x26;</span><span style=color:#24292e> ctx.url </span><span style=color:#d73a49>!==</span><span style=color:#032f62> "/storage/login"</span><span style=color:#24292e>) {</span></span>
<span class=line><span style=color:#d73a49>    if</span><span style=color:#24292e> (</span><span style=color:#d73a49>!</span><span style=color:#24292e>ctx.session.isLogin) {</span></span>
<span class=line><span style=color:#24292e>      ctx.body </span><span style=color:#d73a49>=</span><span style=color:#24292e> r.</span><span style=color:#6f42c1>loginError</span><span style=color:#24292e>();</span></span>
<span class=line><span style=color:#d73a49>      return</span><span style=color:#24292e>;</span></span>
<span class=line><span style=color:#24292e>    }</span></span>
<span class=line><span style=color:#24292e>  }</span></span>
<span class=line><span style=color:#d73a49>  await</span><span style=color:#6f42c1> next</span><span style=color:#24292e>();</span></span>
<span class=line><span style=color:#24292e>});</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>// ...</span></span>
<span class=line><span style=color:#24292e>app.</span><span style=color:#6f42c1>use</span><span style=color:#24292e>(</span></span>
<span class=line><span style=color:#6f42c1>  static</span><span style=color:#24292e>(__dirname </span><span style=color:#d73a49>+</span><span style=color:#032f62> "/public"</span><span style=color:#24292e>, {</span></span>
<span class=line><span style=color:#24292e>    defer: </span><span style=color:#005cc5>true</span><span style=color:#24292e>,</span></span>
<span class=line><span style=color:#24292e>  })</span></span>
<span class=line><span style=color:#24292e>);</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>// ...</span></span>
<span class=line><span style=color:#d73a49>const</span><span style=color:#005cc5> router</span><span style=color:#d73a49> =</span><span style=color:#d73a49> new</span><span style=color:#6f42c1> Router</span><span style=color:#24292e>({</span></span>
<span class=line><span style=color:#24292e>  prefix: </span><span style=color:#032f62>"/storage"</span><span style=color:#24292e>,</span></span>
<span class=line><span style=color:#24292e>});</span></span>
<span class=line></span>
<span class=line><span style=color:#6a737d>// ...</span></span>
<span class=line><span style=color:#24292e>router.</span><span style=color:#6f42c1>post</span><span style=color:#24292e>(</span><span style=color:#032f62>"/login"</span><span style=color:#24292e>, </span><span style=color:#d73a49>async</span><span style=color:#24292e> (</span><span style=color:#e36209>ctx</span><span style=color:#24292e>) </span><span style=color:#d73a49>=></span><span style=color:#24292e> {</span></span>
<span class=line><span style=color:#d73a49>  const</span><span style=color:#24292e> { </span><span style=color:#005cc5>access</span><span style=color:#24292e> } </span><span style=color:#d73a49>=</span><span style=color:#24292e> ctx.request.body;</span></span>
<span class=line><span style=color:#d73a49>  if</span><span style=color:#24292e> (</span><span style=color:#d73a49>!</span><span style=color:#24292e>access) {</span></span>
<span class=line><span style=color:#24292e>    ctx.body </span><span style=color:#d73a49>=</span><span style=color:#24292e> r.</span><span style=color:#6f42c1>parameterError</span><span style=color:#24292e>();</span></span>
<span class=line><span style=color:#d73a49>    return</span><span style=color:#24292e>;</span></span>
<span class=line><span style=color:#24292e>  }</span></span>
<span class=line><span style=color:#d73a49>  try</span><span style=color:#24292e> {</span></span>
<span class=line><span style=color:#d73a49>    const</span><span style=color:#005cc5> base64Decode</span><span style=color:#d73a49> =</span><span style=color:#d73a49> new</span><span style=color:#24292e> Buffer.</span><span style=color:#6f42c1>from</span><span style=color:#24292e>(access, </span><span style=color:#032f62>"base64"</span><span style=color:#24292e>);</span></span>
<span class=line><span style=color:#d73a49>    const</span><span style=color:#005cc5> genAccess</span><span style=color:#d73a49> =</span><span style=color:#24292e> base64Decode.</span><span style=color:#6f42c1>toString</span><span style=color:#24292e>();</span></span>
<span class=line><span style=color:#d73a49>    if</span><span style=color:#24292e> (storageRootKey </span><span style=color:#d73a49>!==</span><span style=color:#24292e> genAccess) {</span></span>
<span class=line><span style=color:#24292e>      ctx.body </span><span style=color:#d73a49>=</span><span style=color:#24292e> r.</span><span style=color:#6f42c1>error</span><span style=color:#24292e>(</span><span style=color:#005cc5>311</span><span style=color:#24292e>, </span><span style=color:#032f62>"密码错误"</span><span style=color:#24292e>);</span></span>
<span class=line><span style=color:#d73a49>      return</span><span style=color:#24292e>;</span></span>
<span class=line><span style=color:#24292e>    }</span></span>
<span class=line><span style=color:#24292e>    ctx.session.isLogin </span><span style=color:#d73a49>=</span><span style=color:#005cc5> true</span><span style=color:#24292e>;</span></span>
<span class=line><span style=color:#6f42c1>    logger</span><span style=color:#24292e>(</span><span style=color:#032f62>"登入Storage"</span><span style=color:#24292e>);</span></span>
<span class=line><span style=color:#24292e>    ctx.body </span><span style=color:#d73a49>=</span><span style=color:#24292e> r.</span><span style=color:#6f42c1>success</span><span style=color:#24292e>();</span></span>
<span class=line><span style=color:#24292e>  } </span><span style=color:#d73a49>catch</span><span style=color:#24292e> (e) {</span></span>
<span class=line><span style=color:#24292e>    ctx.body </span><span style=color:#d73a49>=</span><span style=color:#24292e> r.</span><span style=color:#6f42c1>error</span><span style=color:#24292e>(</span><span style=color:#005cc5>310</span><span style=color:#24292e>, </span><span style=color:#032f62>"登录失败"</span><span style=color:#24292e>);</span></span>
<span class=line><span style=color:#24292e>  }</span></span>
<span class=line><span style=color:#24292e>});</span></span></code></pre></section><p>这里设置的文件系统接口为 storage/*，静态资源服务器为 public/storage，登录时前后端会把密码进行简单 base64 转码。</p><p>若未登录直接访问静态资源，则回返回错误信息。</p><p><strong>未登录直接访问</strong> <img alt=未登录.jpg src=/assets/images/lazy-loading.webp data-byt-lz-src=https://cdn.kongfandong.cn/img/blog/s7aVyTikBU3dGmt.png class=byt-article-img></p><p><strong>登录后在访问</strong> <img alt=已登录.jpg src=/assets/images/lazy-loading.webp data-byt-lz-src=https://cdn.kongfandong.cn/img/blog/KE2a5xBTAkhNUnm.png class=byt-article-img></p><h3 id=断点续传与文件秒传>断点续传与文件秒传</h3><h4 id=文件-md5-计算>文件 md5 计算</h4><p>实现断点续传与文件秒传的前提是需要确定出文件的唯一标识，最好的方式是计算出文件的 md5 值。</p><p>由于选择的 vue-simple-uploader 没有直接提供文件 md5 计算的 api，因此需要手动实现。这里采用 spark-md5 插件计算文件的 md5，在 file-added 事件中，直接用 fileReader 读取文件，根据每个切片循环算出 md5。</p><p>注意尽量不要直接一次读取整个文件的 md5，直接读取大文件在 IE 浏览器中有可能会出现卡死的情况，遍历读取每个切片可以减轻浏览器计算压力。</p><section class=byt-code-box><span class=byt-code-copy></span><pre class="astro-code github-light" data-language=js style=background-color:#fff;color:#24292e;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6f42c1>methods</span><span style=color:#24292e>: {</span></span>
<span class=line><span style=color:#6f42c1>  hanldeFileAdd</span><span style=color:#24292e> (file) {</span></span>
<span class=line><span style=color:#d73a49>    const</span><span style=color:#005cc5> fileList</span><span style=color:#d73a49> =</span><span style=color:#005cc5> this</span><span style=color:#24292e>.$refs.uploader.files</span></span>
<span class=line><span style=color:#d73a49>    const</span><span style=color:#005cc5> index</span><span style=color:#d73a49> =</span><span style=color:#24292e> fileList.</span><span style=color:#6f42c1>findIndex</span><span style=color:#24292e>(</span><span style=color:#e36209>item</span><span style=color:#d73a49> =></span><span style=color:#24292e> item.name </span><span style=color:#d73a49>===</span><span style=color:#24292e> file.name)</span></span>
<span class=line><span style=color:#d73a49>    if</span><span style=color:#24292e> (</span><span style=color:#d73a49>~</span><span style=color:#24292e>index) {</span></span>
<span class=line><span style=color:#24292e>      file.</span><span style=color:#6f42c1>removeFile</span><span style=color:#24292e>(file)</span></span>
<span class=line><span style=color:#24292e>    } </span><span style=color:#d73a49>else</span><span style=color:#24292e> {</span></span>
<span class=line><span style=color:#24292e>      file.targetPath </span><span style=color:#d73a49>=</span><span style=color:#005cc5> this</span><span style=color:#24292e>.currentPath</span></span>
<span class=line><span style=color:#005cc5>      this</span><span style=color:#24292e>.</span><span style=color:#6f42c1>computeMD5</span><span style=color:#24292e>(file)</span></span>
<span class=line><span style=color:#24292e>    }</span></span>
<span class=line><span style=color:#24292e>  },</span></span>
<span class=line><span style=color:#6f42c1>  computeMD5</span><span style=color:#24292e> (file) {</span></span>
<span class=line><span style=color:#d73a49>    const</span><span style=color:#005cc5> fileReader</span><span style=color:#d73a49> =</span><span style=color:#d73a49> new</span><span style=color:#6f42c1> FileReader</span><span style=color:#24292e>()</span></span>
<span class=line><span style=color:#d73a49>    const</span><span style=color:#005cc5> blobSlice</span><span style=color:#d73a49> =</span><span style=color:#005cc5> File</span><span style=color:#24292e>.</span><span style=color:#005cc5>prototype</span><span style=color:#24292e>.slice </span><span style=color:#d73a49>||</span><span style=color:#005cc5> File</span><span style=color:#24292e>.</span><span style=color:#005cc5>prototype</span><span style=color:#24292e>.mozSlice </span><span style=color:#d73a49>||</span><span style=color:#005cc5> File</span><span style=color:#24292e>.</span><span style=color:#005cc5>prototype</span><span style=color:#24292e>.webkitSlice</span></span>
<span class=line><span style=color:#d73a49>    let</span><span style=color:#24292e> currentChunk </span><span style=color:#d73a49>=</span><span style=color:#005cc5> 0</span></span>
<span class=line><span style=color:#d73a49>    const</span><span style=color:#005cc5> chunkSize</span><span style=color:#d73a49> =</span><span style=color:#005cc5> CHUNK_SIZE</span></span>
<span class=line><span style=color:#d73a49>    const</span><span style=color:#005cc5> chunks</span><span style=color:#d73a49> =</span><span style=color:#24292e> Math.</span><span style=color:#6f42c1>ceil</span><span style=color:#24292e>(file.size </span><span style=color:#d73a49>/</span><span style=color:#24292e> chunkSize)</span></span>
<span class=line><span style=color:#d73a49>    const</span><span style=color:#005cc5> spark</span><span style=color:#d73a49> =</span><span style=color:#d73a49> new</span><span style=color:#24292e> SparkMD5.</span><span style=color:#6f42c1>ArrayBuffer</span><span style=color:#24292e>()</span></span>
<span class=line><span style=color:#005cc5>    this</span><span style=color:#24292e>.</span><span style=color:#6f42c1>$nextTick</span><span style=color:#24292e>(() </span><span style=color:#d73a49>=></span><span style=color:#24292e> {</span></span>
<span class=line><span style=color:#005cc5>      this</span><span style=color:#24292e>.</span><span style=color:#6f42c1>createMD5Element</span><span style=color:#24292e>(file)</span></span>
<span class=line><span style=color:#24292e>    })</span></span>
<span class=line><span style=color:#6f42c1>    loadNext</span><span style=color:#24292e>()</span></span>
<span class=line><span style=color:#24292e>    fileReader.</span><span style=color:#6f42c1>onload</span><span style=color:#d73a49> =</span><span style=color:#e36209> e</span><span style=color:#d73a49> =></span><span style=color:#24292e> {</span></span>
<span class=line><span style=color:#24292e>      spark.</span><span style=color:#6f42c1>append</span><span style=color:#24292e>(e.target.result)</span></span>
<span class=line><span style=color:#d73a49>      if</span><span style=color:#24292e> (currentChunk </span><span style=color:#d73a49>&#x3C;</span><span style=color:#24292e> chunks) {</span></span>
<span class=line><span style=color:#24292e>        currentChunk</span><span style=color:#d73a49>++</span></span>
<span class=line><span style=color:#6f42c1>        loadNext</span><span style=color:#24292e>()</span></span>
<span class=line><span style=color:#005cc5>        this</span><span style=color:#24292e>.</span><span style=color:#6f42c1>$nextTick</span><span style=color:#24292e>(() </span><span style=color:#d73a49>=></span><span style=color:#24292e> {</span></span>
<span class=line><span style=color:#005cc5>          this</span><span style=color:#24292e>.</span><span style=color:#6f42c1>setMD5ElementText</span><span style=color:#24292e>(file, </span><span style=color:#032f62>`校验MD5 ${</span><span style=color:#032f62>((</span><span style=color:#24292e>currentChunk</span><span style=color:#d73a49> /</span><span style=color:#24292e> chunks</span><span style=color:#032f62>) </span><span style=color:#d73a49>*</span><span style=color:#005cc5> 100</span><span style=color:#032f62>).</span><span style=color:#6f42c1>toFixed</span><span style=color:#032f62>(</span><span style=color:#005cc5>0</span><span style=color:#032f62>)</span><span style=color:#032f62>}%`</span><span style=color:#24292e>)</span></span>
<span class=line><span style=color:#24292e>          document.</span><span style=color:#6f42c1>querySelector</span><span style=color:#24292e>(</span><span style=color:#032f62>`.uploader-list .file-${</span><span style=color:#24292e>file</span><span style=color:#032f62>.</span><span style=color:#24292e>id</span><span style=color:#032f62>} .uploader-file-actions`</span><span style=color:#24292e>).style.display </span><span style=color:#d73a49>=</span><span style=color:#032f62> 'none'</span></span>
<span class=line><span style=color:#24292e>        })</span></span>
<span class=line><span style=color:#24292e>      } </span><span style=color:#d73a49>else</span><span style=color:#24292e> {</span></span>
<span class=line><span style=color:#d73a49>        const</span><span style=color:#005cc5> md5</span><span style=color:#d73a49> =</span><span style=color:#24292e> spark.</span><span style=color:#6f42c1>end</span><span style=color:#24292e>()</span></span>
<span class=line><span style=color:#24292e>        file.uniqueIdentifier </span><span style=color:#d73a49>=</span><span style=color:#24292e> md5</span></span>
<span class=line><span style=color:#24292e>        file.</span><span style=color:#6f42c1>resume</span><span style=color:#24292e>()</span></span>
<span class=line><span style=color:#005cc5>        this</span><span style=color:#24292e>.</span><span style=color:#6f42c1>destoryMD5Element</span><span style=color:#24292e>(file)</span></span>
<span class=line><span style=color:#24292e>        document.</span><span style=color:#6f42c1>querySelector</span><span style=color:#24292e>(</span><span style=color:#032f62>`.uploader-list .file-${</span><span style=color:#24292e>file</span><span style=color:#032f62>.</span><span style=color:#24292e>id</span><span style=color:#032f62>} .uploader-file-actions`</span><span style=color:#24292e>).style.display </span><span style=color:#d73a49>=</span><span style=color:#032f62> 'block'</span></span>
<span class=line><span style=color:#24292e>      }</span></span>
<span class=line><span style=color:#24292e>    }</span></span>
<span class=line><span style=color:#24292e>    fileReader.</span><span style=color:#6f42c1>onerror</span><span style=color:#d73a49> =</span><span style=color:#d73a49> function</span><span style=color:#24292e> () {</span></span>
<span class=line><span style=color:#005cc5>      this</span><span style=color:#24292e>.</span><span style=color:#6f42c1>$nextTick</span><span style=color:#24292e>(() </span><span style=color:#d73a49>=></span><span style=color:#24292e> {</span></span>
<span class=line><span style=color:#005cc5>        this</span><span style=color:#24292e>.</span><span style=color:#6f42c1>setMD5ElementText</span><span style=color:#24292e>(file, </span><span style=color:#032f62>'校验MD5失败'</span><span style=color:#24292e>)</span></span>
<span class=line><span style=color:#24292e>      })</span></span>
<span class=line><span style=color:#24292e>      file.</span><span style=color:#6f42c1>cancel</span><span style=color:#24292e>()</span></span>
<span class=line><span style=color:#24292e>    }</span></span>
<span class=line><span style=color:#d73a49>    function</span><span style=color:#6f42c1> loadNext</span><span style=color:#24292e> () {</span></span>
<span class=line><span style=color:#d73a49>      const</span><span style=color:#005cc5> start</span><span style=color:#d73a49> =</span><span style=color:#24292e> currentChunk </span><span style=color:#d73a49>*</span><span style=color:#24292e> chunkSize</span></span>
<span class=line><span style=color:#d73a49>      const</span><span style=color:#005cc5> end</span><span style=color:#d73a49> =</span><span style=color:#24292e> ((start </span><span style=color:#d73a49>+</span><span style=color:#24292e> chunkSize) </span><span style=color:#d73a49>>=</span><span style=color:#24292e> file.size) </span><span style=color:#d73a49>?</span><span style=color:#24292e> file.size </span><span style=color:#d73a49>:</span><span style=color:#24292e> start </span><span style=color:#d73a49>+</span><span style=color:#24292e> chunkSize</span></span>
<span class=line><span style=color:#24292e>      fileReader.</span><span style=color:#6f42c1>readAsArrayBuffer</span><span style=color:#24292e>(blobSlice.</span><span style=color:#6f42c1>call</span><span style=color:#24292e>(file.file, start, end))</span></span>
<span class=line><span style=color:#24292e>    }</span></span>
<span class=line><span style=color:#24292e>  },</span></span>
<span class=line><span style=color:#6f42c1>  createMD5Element</span><span style=color:#24292e> (file) {</span></span>
<span class=line><span style=color:#005cc5>    this</span><span style=color:#24292e>.</span><span style=color:#6f42c1>$nextTick</span><span style=color:#24292e>(() </span><span style=color:#d73a49>=></span><span style=color:#24292e> {</span></span>
<span class=line><span style=color:#d73a49>      const</span><span style=color:#005cc5> el</span><span style=color:#d73a49> =</span><span style=color:#24292e> document.</span><span style=color:#6f42c1>querySelector</span><span style=color:#24292e>(</span><span style=color:#032f62>`.uploader-list .file-${</span><span style=color:#24292e>file</span><span style=color:#032f62>.</span><span style=color:#24292e>id</span><span style=color:#032f62>} .uploader-file-status`</span><span style=color:#24292e>)</span></span>
<span class=line><span style=color:#d73a49>      const</span><span style=color:#005cc5> MD5Status</span><span style=color:#d73a49> =</span><span style=color:#24292e> document.</span><span style=color:#6f42c1>createElement</span><span style=color:#24292e>(</span><span style=color:#032f62>'div'</span><span style=color:#24292e>)</span></span>
<span class=line><span style=color:#24292e>      MD5Status.</span><span style=color:#6f42c1>setAttribute</span><span style=color:#24292e>(</span><span style=color:#032f62>'class'</span><span style=color:#24292e>, </span><span style=color:#032f62>'md5-status'</span><span style=color:#24292e>)</span></span>
<span class=line><span style=color:#24292e>      el.</span><span style=color:#6f42c1>appendChild</span><span style=color:#24292e>(MD5Status)</span></span>
<span class=line><span style=color:#24292e>    })</span></span>
<span class=line><span style=color:#24292e>  },</span></span>
<span class=line><span style=color:#6f42c1>  destoryMD5Element</span><span style=color:#24292e> (file) {</span></span>
<span class=line><span style=color:#005cc5>    this</span><span style=color:#24292e>.</span><span style=color:#6f42c1>$nextTick</span><span style=color:#24292e>(() </span><span style=color:#d73a49>=></span><span style=color:#24292e> {</span></span>
<span class=line><span style=color:#d73a49>      const</span><span style=color:#005cc5> el</span><span style=color:#d73a49> =</span><span style=color:#24292e> document.</span><span style=color:#6f42c1>querySelector</span><span style=color:#24292e>(</span><span style=color:#032f62>`.uploader-list .file-${</span><span style=color:#24292e>file</span><span style=color:#032f62>.</span><span style=color:#24292e>id</span><span style=color:#032f62>} .uploader-file-status .md5-status`</span><span style=color:#24292e>)</span></span>
<span class=line><span style=color:#d73a49>      if</span><span style=color:#24292e> (el) {</span></span>
<span class=line><span style=color:#24292e>        el.parentNode.</span><span style=color:#6f42c1>removeChild</span><span style=color:#24292e>(el)</span></span>
<span class=line><span style=color:#24292e>      }</span></span>
<span class=line><span style=color:#24292e>    })</span></span>
<span class=line><span style=color:#24292e>  },</span></span>
<span class=line><span style=color:#6f42c1>  setMD5ElementText</span><span style=color:#24292e> (file, text) {</span></span>
<span class=line><span style=color:#d73a49>    const</span><span style=color:#005cc5> el</span><span style=color:#d73a49> =</span><span style=color:#24292e> document.</span><span style=color:#6f42c1>querySelector</span><span style=color:#24292e>(</span><span style=color:#032f62>`.uploader-list .file-${</span><span style=color:#24292e>file</span><span style=color:#032f62>.</span><span style=color:#24292e>id</span><span style=color:#032f62>} .uploader-file-status .md5-status`</span><span style=color:#24292e>)</span></span>
<span class=line><span style=color:#d73a49>    if</span><span style=color:#24292e> (el) {</span></span>
<span class=line><span style=color:#24292e>      el.innerText </span><span style=color:#d73a49>=</span><span style=color:#24292e> text</span></span>
<span class=line><span style=color:#24292e>    }</span></span>
<span class=line><span style=color:#24292e>  }</span></span>
<span class=line><span style=color:#24292e>}</span></span></code></pre></section><p>将计算完的 MD5 直接替换到 file 对象的 uniqueIdentifier 属性上，最终发送的请求中的 identifier 将是文件的 MD5，后端通过该字段进行识别。</p><p>Vue-simple-uploader 文件列表状态需要加入计算 MD5 相关状态，可以通过 css 为原文件列表增加多一层 md5 状态层，然后通过相关事件进行显隐。</p><p><img alt=md5-status.jpg src=/assets/images/lazy-loading.webp data-byt-lz-src=https://cdn.kongfandong.cn/img/blog/xF1pgQ9WGhZ7X6i.png class=byt-article-img></p><h4 id=断点续传>断点续传</h4><p>默认 Vue-simple-uploader 提供了文件上传时的暂停/开始操作，你可以在上传过程中随时暂停。但是这个并不是真正的断点续传，因为页面刷新后，上传状态并没有保存下来，仍会重新从第一片重新上传。若将状态保留到 localstorage 中，仍是不太现实的，最好的方式是由后端返回是否需要当前这个切片，因为后端能知道当前该文件已上传的切片。</p><p>testChunks 属性设为 true（默认）时，每个切片会先发送一个不含文件流的预探 get 请求给后端，通过后端返回的 http 状态码（可更改）判断该切片是否需要发送。</p><p>默认每个切片都会发送一个预探请求，这样假如一个 10 个切片的文件就会产生 20 个请求，造成浪费。最理想的情况是预探请求只发送一个。新版 simple-uplder 也考虑到这点，并提供了 checkChunkUploadedByResponse 属性，可以将预探请求设置为一个，后端为这个预探请求直接返回当前已经有的切片数组，然后前端直接判断切片请求是否需要发送。</p><p>例：文件上传到一半，点了暂停，然后刷新网页，再重新上传。文件校验完 Md5 后，预探请求返回已存在的切片数组[1~25]，然后真正切片请求会直接从第 26 片开始上传。</p><p><img alt=续传.jpg src=/assets/images/lazy-loading.webp data-byt-lz-src=https://cdn.kongfandong.cn/img/blog/asoDtjuVrNLdFyX.png class=byt-article-img></p><p><strong>前端处理</strong></p><section class=byt-code-box><span class=byt-code-copy></span><pre class="astro-code github-light" data-language=js style=background-color:#fff;color:#24292e;overflow-x:auto tabindex=0><code><span class=line><span style=color:#6a737d>// 前端vue-simple-uploader配置项</span></span>
<span class=line><span style=color:#6f42c1>options</span><span style=color:#24292e>: {</span></span>
<span class=line><span style=color:#6f42c1>  target</span><span style=color:#24292e>: (</span><span style=color:#e36209>instance</span><span style=color:#24292e>, </span><span style=color:#e36209>chunk</span><span style=color:#24292e>, </span><span style=color:#e36209>isTest</span><span style=color:#24292e>) </span><span style=color:#d73a49>=></span><span style=color:#24292e> isTest </span><span style=color:#d73a49>?</span><span style=color:#032f62> '/api/storage/testUpload'</span><span style=color:#d73a49> :</span><span style=color:#032f62> '/api/storage/upload'</span><span style=color:#24292e>,</span></span>
<span class=line><span style=color:#6f42c1>  query</span><span style=color:#24292e>: () </span><span style=color:#d73a49>=></span><span style=color:#24292e> {</span></span>
<span class=line><span style=color:#d73a49>    return</span><span style=color:#24292e> {</span></span>
<span class=line><span style=color:#24292e>      targetPath: </span><span style=color:#005cc5>this</span><span style=color:#24292e>.currentPath</span></span>
<span class=line><span style=color:#24292e>    }</span></span>
<span class=line><span style=color:#24292e>  },</span></span>
<span class=line><span style=color:#6f42c1>  chunkSize</span><span style=color:#24292e>: </span><span style=color:#005cc5>CHUNK_SIZE</span><span style=color:#24292e>,</span></span>
<span class=line><span style=color:#6f42c1>  allowDuplicateUploads</span><span style=color:#24292e>: </span><span style=color:#005cc5>false</span><span style=color:#24292e>,</span></span>
<span class=line><span style=color:#6f42c1>  checkChunkUploadedByResponse</span><span style=color:#24292e>: (</span><span style=color:#e36209>chunk</span><span style=color:#24292e>, </span><span style=color:#e36209>message</span><span style=color:#24292e>) </span><span style=color:#d73a49>=></span><span style=color:#24292e> {</span></span>
<span class=line><span style=color:#d73a49>    const</span><span style=color:#005cc5> response</span><span style=color:#d73a49> =</span><span style=color:#005cc5> JSON</span><span style=color:#24292e>.</span><span style=color:#6f42c1>parse</span><span style=color:#24292e>(message)</span></span>
<span class=line><span style=color:#d73a49>    const</span><span style=color:#005cc5> existChunk</span><span style=color:#d73a49> =</span><span style=color:#24292e> response.data.</span><span style=color:#6f42c1>map</span><span style=color:#24292e>(</span><span style=color:#e36209>item</span><span style=color:#d73a49> =></span><span style=color:#d73a49> ~~</span><span style=color:#24292e>item)</span></span>
<span class=line><span style=color:#d73a49>    return</span><span style=color:#24292e> existChunk.</span><span style=color:#6f42c1>includes</span><span style=color:#24292e>(chunk.offset </span><span style=color:#d73a49>+</span><span style=color:#005cc5> 1</span><span style=color:#24292e>)</span></span>
<span class=line><span style=color:#24292e>  }</span></span>
<span class=line><span style=color:#24292e>}</span></span></code></pre></section><p>其中/storage/testUpload 为预探请求（get），storage/upload 为真正切片上传请求（post）。checkChunkUploadedByResponse 控制只上传后端不存在的切片。</p><p><strong>后端处理</strong></p><section class=byt-code-box><span class=byt-code-copy></span><pre class="astro-code github-light" data-language=js style=background-color:#fff;color:#24292e;overflow-x:auto tabindex=0><code><span class=line><span style=color:#24292e>router.</span><span style=color:#6f42c1>get</span><span style=color:#24292e>(</span><span style=color:#032f62>"/testUpload"</span><span style=color:#24292e>, </span><span style=color:#d73a49>async</span><span style=color:#24292e> (</span><span style=color:#e36209>ctx</span><span style=color:#24292e>) </span><span style=color:#d73a49>=></span><span style=color:#24292e> {</span></span>
<span class=line><span style=color:#d73a49>  const</span><span style=color:#24292e> { </span><span style=color:#005cc5>identifier</span><span style=color:#24292e>, </span><span style=color:#005cc5>filename</span><span style=color:#24292e>, </span><span style=color:#005cc5>targetPath</span><span style=color:#d73a49> =</span><span style=color:#032f62> "$Root"</span><span style=color:#24292e>, </span><span style=color:#005cc5>totalChunks</span><span style=color:#24292e> } </span><span style=color:#d73a49>=</span><span style=color:#24292e> ctx.query;</span></span>
<span class=line><span style=color:#d73a49>  const</span><span style=color:#005cc5> chunkFolderURL</span><span style=color:#d73a49> =</span><span style=color:#032f62> `${</span><span style=color:#24292e>storageChunkPath</span><span style=color:#032f62>}/${</span><span style=color:#24292e>identifier</span><span style=color:#032f62>}`</span><span style=color:#24292e>;</span></span>
<span class=line><span style=color:#d73a49>  try</span><span style=color:#24292e> {</span></span>
<span class=line><span style=color:#d73a49>    const</span><span style=color:#005cc5> checkExistResult</span><span style=color:#d73a49> =</span><span style=color:#d73a49> await</span><span style=color:#6f42c1> query</span><span style=color:#24292e>(</span></span>
<span class=line><span style=color:#032f62>      `select * from storage where id = ? and isComplete = 1 and isDel = 0`</span><span style=color:#24292e>,</span></span>
<span class=line><span style=color:#24292e>      identifier</span></span>
<span class=line><span style=color:#24292e>    );</span></span>
<span class=line><span style=color:#6a737d>    // 检查是否已经完整上传过该文件</span></span>
<span class=line><span style=color:#d73a49>    if</span><span style=color:#24292e> (checkExistResult.</span><span style=color:#005cc5>length</span><span style=color:#d73a49> ></span><span style=color:#005cc5> 0</span><span style=color:#24292e>) {</span></span>
<span class=line><span style=color:#d73a49>      let</span><span style=color:#24292e> { fullPath } </span><span style=color:#d73a49>=</span><span style=color:#24292e> checkExistResult[</span><span style=color:#005cc5>0</span><span style=color:#24292e>];</span></span>
<span class=line><span style=color:#d73a49>      let</span><span style=color:#24292e> realPath </span><span style=color:#d73a49>=</span><span style=color:#24292e> fullPath.</span><span style=color:#6f42c1>replace</span><span style=color:#24292e>(</span><span style=color:#032f62>"$Root"</span><span style=color:#24292e>, storageRootPath);</span></span>
<span class=line><span style=color:#6a737d>      // 检查当前DB信息是否与物理存储相符</span></span>
<span class=line><span style=color:#d73a49>      if</span><span style=color:#24292e> (fs.</span><span style=color:#6f42c1>existsSync</span><span style=color:#24292e>(realPath)) {</span></span>
<span class=line><span style=color:#6a737d>        // 检查目标位置是否与之前上传的位置一样，不一致则复制过去</span></span>
<span class=line><span style=color:#d73a49>        let</span><span style=color:#24292e> targetFilePath </span><span style=color:#d73a49>=</span><span style=color:#032f62> `${</span><span style=color:#24292e>targetPath</span><span style=color:#032f62>}/${</span><span style=color:#24292e>filename</span><span style=color:#032f62>}`</span><span style=color:#24292e>;</span></span>
<span class=line><span style=color:#d73a49>        if</span><span style=color:#24292e> (fullPath </span><span style=color:#d73a49>!==</span><span style=color:#24292e> targetFilePath) {</span></span>
<span class=line><span style=color:#24292e>          targetFilePath </span><span style=color:#d73a49>=</span><span style=color:#24292e> targetFilePath.</span><span style=color:#6f42c1>replace</span><span style=color:#24292e>(</span><span style=color:#032f62>"$Root"</span><span style=color:#24292e>, storageRootPath);</span></span>
<span class=line><span style=color:#24292e>          fs.</span><span style=color:#6f42c1>copyFileSync</span><span style=color:#24292e>(realPath, targetFilePath);</span></span>
<span class=line><span style=color:#24292e>        }</span></span>
<span class=line><span style=color:#6a737d>        // 返回全部分片数组</span></span>
<span class=line><span style=color:#d73a49>        const</span><span style=color:#005cc5> chunksArr</span><span style=color:#d73a49> =</span><span style=color:#24292e> Array.</span><span style=color:#6f42c1>from</span><span style=color:#24292e>(</span></span>
<span class=line><span style=color:#24292e>          { length: totalChunks },</span></span>
<span class=line><span style=color:#24292e>          (</span><span style=color:#e36209>item</span><span style=color:#24292e>, </span><span style=color:#e36209>index</span><span style=color:#24292e>) </span><span style=color:#d73a49>=></span><span style=color:#24292e> index </span><span style=color:#d73a49>+</span><span style=color:#005cc5> 1</span></span>
<span class=line><span style=color:#24292e>        );</span></span>
<span class=line><span style=color:#24292e>        ctx.body </span><span style=color:#d73a49>=</span><span style=color:#24292e> r.</span><span style=color:#6f42c1>successData</span><span style=color:#24292e>(chunksArr);</span></span>
<span class=line><span style=color:#d73a49>        return</span><span style=color:#24292e>;</span></span>
<span class=line><span style=color:#24292e>      }</span></span>
<span class=line><span style=color:#24292e>    }</span></span>
<span class=line><span style=color:#d73a49>    if</span><span style=color:#24292e> (</span><span style=color:#d73a49>!</span><span style=color:#24292e>fs.</span><span style=color:#6f42c1>existsSync</span><span style=color:#24292e>(chunkFolderURL)) {</span></span>
<span class=line><span style=color:#24292e>      fs.</span><span style=color:#6f42c1>mkdirSync</span><span style=color:#24292e>(chunkFolderURL, { recursive: </span><span style=color:#005cc5>true</span><span style=color:#24292e> });</span></span>
<span class=line><span style=color:#d73a49>      const</span><span style=color:#005cc5> now</span><span style=color:#d73a49> =</span><span style=color:#6f42c1> DateFormat</span><span style=color:#24292e>(</span><span style=color:#d73a49>new</span><span style=color:#6f42c1> Date</span><span style=color:#24292e>(), </span><span style=color:#032f62>"yyyy-MM-dd HH:mm:ss"</span><span style=color:#24292e>);</span></span>
<span class=line><span style=color:#d73a49>      const</span><span style=color:#005cc5> sql</span><span style=color:#d73a49> =</span><span style=color:#032f62> `replace into storage(id, fullPath, updatedTime, isComplete, isDel) values(?, ?, ?, 0, 0)`</span><span style=color:#24292e>;</span></span>
<span class=line><span style=color:#d73a49>      await</span><span style=color:#6f42c1> query</span><span style=color:#24292e>(sql, [identifier, </span><span style=color:#032f62>`${</span><span style=color:#24292e>targetPath</span><span style=color:#032f62>}/${</span><span style=color:#24292e>filename</span><span style=color:#032f62>}`</span><span style=color:#24292e>, now]);</span></span>
<span class=line><span style=color:#24292e>      ctx.body </span><span style=color:#d73a49>=</span><span style=color:#24292e> r.</span><span style=color:#6f42c1>successData</span><span style=color:#24292e>([]);</span></span>
<span class=line><span style=color:#24292e>    } </span><span style=color:#d73a49>else</span><span style=color:#24292e> {</span></span>
<span class=line><span style=color:#d73a49>      const</span><span style=color:#005cc5> ls</span><span style=color:#d73a49> =</span><span style=color:#24292e> fs.</span><span style=color:#6f42c1>readdirSync</span><span style=color:#24292e>(chunkFolderURL);</span></span>
<span class=line><span style=color:#24292e>      ctx.body </span><span style=color:#d73a49>=</span><span style=color:#24292e> r.</span><span style=color:#6f42c1>successData</span><span style=color:#24292e>(ls);</span></span>
<span class=line><span style=color:#24292e>    }</span></span>
<span class=line><span style=color:#24292e>  } </span><span style=color:#d73a49>catch</span><span style=color:#24292e> (e) {</span></span>
<span class=line><span style=color:#24292e>    ctx.status </span><span style=color:#d73a49>=</span><span style=color:#005cc5> 501</span><span style=color:#24292e>;</span></span>
<span class=line><span style=color:#24292e>    ctx.body </span><span style=color:#d73a49>=</span><span style=color:#24292e> r.</span><span style=color:#6f42c1>error</span><span style=color:#24292e>(</span><span style=color:#005cc5>306</span><span style=color:#24292e>, e);</span></span>
<span class=line><span style=color:#24292e>  }</span></span>
<span class=line><span style=color:#24292e>});</span></span>
<span class=line></span>
<span class=line><span style=color:#24292e>router.</span><span style=color:#6f42c1>post</span><span style=color:#24292e>(</span><span style=color:#032f62>"/upload"</span><span style=color:#24292e>, </span><span style=color:#d73a49>async</span><span style=color:#24292e> (</span><span style=color:#e36209>ctx</span><span style=color:#24292e>) </span><span style=color:#d73a49>=></span><span style=color:#24292e> {</span></span>
<span class=line><span style=color:#d73a49>  const</span><span style=color:#24292e> {</span></span>
<span class=line><span style=color:#005cc5>    chunkNumber</span><span style=color:#24292e>,</span></span>
<span class=line><span style=color:#005cc5>    identifier</span><span style=color:#24292e>,</span></span>
<span class=line><span style=color:#005cc5>    filename</span><span style=color:#24292e>,</span></span>
<span class=line><span style=color:#005cc5>    totalChunks</span><span style=color:#24292e>,</span></span>
<span class=line><span style=color:#005cc5>    targetPath</span><span style=color:#d73a49> =</span><span style=color:#032f62> "$Root"</span><span style=color:#24292e>,</span></span>
<span class=line><span style=color:#24292e>  } </span><span style=color:#d73a49>=</span><span style=color:#24292e> ctx.request.body;</span></span>
<span class=line><span style=color:#d73a49>  const</span><span style=color:#24292e> { </span><span style=color:#005cc5>file</span><span style=color:#24292e> } </span><span style=color:#d73a49>=</span><span style=color:#24292e> ctx.request.files;</span></span>
<span class=line><span style=color:#d73a49>  const</span><span style=color:#005cc5> chunkFolderURL</span><span style=color:#d73a49> =</span><span style=color:#032f62> `./public/storage-chunk/${</span><span style=color:#24292e>identifier</span><span style=color:#032f62>}`</span><span style=color:#24292e>;</span></span>
<span class=line><span style=color:#d73a49>  const</span><span style=color:#005cc5> chunkFileURL</span><span style=color:#d73a49> =</span><span style=color:#032f62> `${</span><span style=color:#24292e>chunkFolderURL</span><span style=color:#032f62>}/${</span><span style=color:#24292e>chunkNumber</span><span style=color:#032f62>}`</span><span style=color:#24292e>;</span></span>
<span class=line><span style=color:#d73a49>  if</span><span style=color:#24292e> (chunkNumber </span><span style=color:#d73a49>!==</span><span style=color:#24292e> totalChunks) {</span></span>
<span class=line><span style=color:#d73a49>    const</span><span style=color:#005cc5> reader</span><span style=color:#d73a49> =</span><span style=color:#24292e> fs.</span><span style=color:#6f42c1>createReadStream</span><span style=color:#24292e>(file.path);</span></span>
<span class=line><span style=color:#d73a49>    const</span><span style=color:#005cc5> upStream</span><span style=color:#d73a49> =</span><span style=color:#24292e> fs.</span><span style=color:#6f42c1>createWriteStream</span><span style=color:#24292e>(chunkFileURL);</span></span>
<span class=line><span style=color:#24292e>    reader.</span><span style=color:#6f42c1>pipe</span><span style=color:#24292e>(upStream);</span></span>
<span class=line><span style=color:#24292e>    ctx.body </span><span style=color:#d73a49>=</span><span style=color:#24292e> r.</span><span style=color:#6f42c1>success</span><span style=color:#24292e>();</span></span>
<span class=line><span style=color:#24292e>  } </span><span style=color:#d73a49>else</span><span style=color:#24292e> {</span></span>
<span class=line><span style=color:#d73a49>    const</span><span style=color:#005cc5> targetFile</span><span style=color:#d73a49> =</span><span style=color:#032f62> `${</span><span style=color:#24292e>targetPath</span><span style=color:#032f62>}/${</span><span style=color:#24292e>filename</span><span style=color:#032f62>}`</span><span style=color:#24292e>.</span><span style=color:#6f42c1>replace</span><span style=color:#24292e>(</span></span>
<span class=line><span style=color:#032f62>      "$Root"</span><span style=color:#24292e>,</span></span>
<span class=line><span style=color:#24292e>      storageRootPath</span></span>
<span class=line><span style=color:#24292e>    );</span></span>
<span class=line><span style=color:#24292e>    fs.</span><span style=color:#6f42c1>writeFileSync</span><span style=color:#24292e>(targetFile, </span><span style=color:#032f62>""</span><span style=color:#24292e>);</span></span>
<span class=line><span style=color:#d73a49>    try</span><span style=color:#24292e> {</span></span>
<span class=line><span style=color:#d73a49>      for</span><span style=color:#24292e> (</span><span style=color:#d73a49>let</span><span style=color:#24292e> i </span><span style=color:#d73a49>=</span><span style=color:#005cc5> 1</span><span style=color:#24292e>; i </span><span style=color:#d73a49>&#x3C;=</span><span style=color:#24292e> totalChunks; i</span><span style=color:#d73a49>++</span><span style=color:#24292e>) {</span></span>
<span class=line><span style=color:#d73a49>        const</span><span style=color:#005cc5> url</span><span style=color:#d73a49> =</span><span style=color:#24292e> i </span><span style=color:#d73a49>==</span><span style=color:#24292e> totalChunks </span><span style=color:#d73a49>?</span><span style=color:#24292e> file.path </span><span style=color:#d73a49>:</span><span style=color:#032f62> `${</span><span style=color:#24292e>chunkFolderURL</span><span style=color:#032f62>}/${</span><span style=color:#24292e>i</span><span style=color:#032f62>}`</span><span style=color:#24292e>;</span></span>
<span class=line><span style=color:#d73a49>        const</span><span style=color:#005cc5> buffer</span><span style=color:#d73a49> =</span><span style=color:#24292e> fs.</span><span style=color:#6f42c1>readFileSync</span><span style=color:#24292e>(url);</span></span>
<span class=line><span style=color:#24292e>        fs.</span><span style=color:#6f42c1>appendFileSync</span><span style=color:#24292e>(targetFile, buffer);</span></span>
<span class=line><span style=color:#24292e>      }</span></span>
<span class=line><span style=color:#d73a49>      const</span><span style=color:#005cc5> now</span><span style=color:#d73a49> =</span><span style=color:#6f42c1> DateFormat</span><span style=color:#24292e>(</span><span style=color:#d73a49>new</span><span style=color:#6f42c1> Date</span><span style=color:#24292e>(), </span><span style=color:#032f62>"yyyy-MM-dd HH:mm:ss"</span><span style=color:#24292e>);</span></span>
<span class=line><span style=color:#d73a49>      const</span><span style=color:#005cc5> sql</span><span style=color:#d73a49> =</span><span style=color:#032f62> `update storage set isComplete = 1, updatedTime = ? where id = ?`</span><span style=color:#24292e>;</span></span>
<span class=line><span style=color:#d73a49>      await</span><span style=color:#6f42c1> query</span><span style=color:#24292e>(sql, [now, identifier]);</span></span>
<span class=line><span style=color:#24292e>      ctx.body </span><span style=color:#d73a49>=</span><span style=color:#24292e> r.</span><span style=color:#6f42c1>success</span><span style=color:#24292e>();</span></span>
<span class=line><span style=color:#6f42c1>      deleteFolder</span><span style=color:#24292e>(chunkFolderURL);</span></span>
<span class=line><span style=color:#6f42c1>      logger</span><span style=color:#24292e>(</span></span>
<span class=line><span style=color:#032f62>        "文件上传成功"</span><span style=color:#24292e>,</span></span>
<span class=line><span style=color:#005cc5>        1</span><span style=color:#24292e>,</span></span>
<span class=line><span style=color:#032f62>        `targetFile: ${</span><span style=color:#24292e>targetFile</span><span style=color:#032f62>}, MD5:${</span><span style=color:#24292e>identifier</span><span style=color:#032f62>}, 切片源删除成功`</span></span>
<span class=line><span style=color:#24292e>      );</span></span>
<span class=line><span style=color:#24292e>    } </span><span style=color:#d73a49>catch</span><span style=color:#24292e> (e) {</span></span>
<span class=line><span style=color:#24292e>      ctx.status </span><span style=color:#d73a49>=</span><span style=color:#005cc5> 501</span><span style=color:#24292e>;</span></span>
<span class=line><span style=color:#24292e>      ctx.body </span><span style=color:#d73a49>=</span><span style=color:#24292e> r.</span><span style=color:#6f42c1>error</span><span style=color:#24292e>(</span><span style=color:#005cc5>501</span><span style=color:#24292e>, e);</span></span>
<span class=line><span style=color:#6f42c1>      logger</span><span style=color:#24292e>(</span><span style=color:#032f62>"文件合并失败"</span><span style=color:#24292e>, </span><span style=color:#005cc5>0</span><span style=color:#24292e>, </span><span style=color:#032f62>`分片丢失 => ${</span><span style=color:#24292e>e</span><span style=color:#032f62>}`</span><span style=color:#24292e>);</span></span>
<span class=line><span style=color:#24292e>      fs.</span><span style=color:#6f42c1>unlinkSync</span><span style=color:#24292e>(targetFile);</span></span>
<span class=line><span style=color:#24292e>    }</span></span>
<span class=line><span style=color:#24292e>  }</span></span>
<span class=line><span style=color:#24292e>});</span></span></code></pre></section><p>在 testUpload 请求中，通过数据库与本地切片生成已存在的切片数组给前端，若从未传过还需要更新数据库记录。</p><p>在 upload 请求中，对每个切片使用 nodejs 管道流进行读写，将文件保留在 chunk 文件夹中，并以 md5 值为文件名，存放目标文件的切片。当遇到最后一个切片时，执行合并文件操作（需要注意，最后一个切片由于流未关闭，这个时刻最后一个切片文件是还没保存到本地，只是可以直接读取临时文件）。合并文件完成后，删除切片文件夹，并更新数据库信息，记录该文件已经完成。</p><p><img alt=切片存放.jpg src=/assets/images/lazy-loading.webp data-byt-lz-src=https://cdn.kongfandong.cn/img/blog/lLGko4FJcxUs1n8.png class=byt-article-img></p><p>当上传一个本地已经存在的文件时，由于数据库记录了该 md5 文件是已经完成的，所以预探请求会返回全部切片数组，前端就不会再发送 upload 请求从而实现了文件秒传。即使上传的目标目录与本地已存在文件处在不同目录，在预探请求时识别到时，也会进行复制操作，前端也不需要再传。</p><p><strong>断点续传演示</strong> <img alt=断点续传.gif src=/assets/images/lazy-loading.webp data-byt-lz-src=https://cdn.kongfandong.cn/img/blog/tXQRgNm752BCyY9.gif class=byt-article-img></p><p>上传过程暂停，然后刷新页面，重新上传同一个文件，可以发现文件是从上传暂停的地方重新开始。</p><p><strong>文件秒传演示</strong> <img alt=文件秒传.gif src=/assets/images/lazy-loading.webp data-byt-lz-src=https://i.imgur.com/8lX6kJ4.gif class=byt-article-img></p><p>上传上面演示的同一个文件，由于发现是已经存在的文件，则会直接返回成功。</p><p>至此，一个断点续传、秒传功能的前后端都实现完了。</p><p>另外该系统还有一些对文件进行移动、删除、下载的功能都是比较简单的，基本都是使用 nodejs 的 fs 模块就能实现，这里就不细说了。</p><p>该系统前端 Git: <a href=https://github.com/leon-kfd/FileSystem target=_blank></a><a href=https://github.com/leon-kfd/FileSystem target=_blank rel="noopener nofollow"><span>https://github.com/leon-kfd/FileSystem</span></a></p><p>由于目前该后端是嵌入到了本人的其他系统里面，还未能开源，等有空会整理出一份。同时系统部分功能由于时间问题也还没有空去完善，望见谅。</p><section class=tag-list></section></main><footer><section class=byt-copyright><p>本文由 <span>boycot</span> 于 2020-05-05 凌晨 发布</p><p>文章地址：<a href=https://astro-blog.boycot.top/article/断点续传与个人网盘系统的前后端设计>断点续传与个人网盘系统的前后端设计</a></p><p>本博客所有文章除特别声明外，均采用 <a href=https://creativecommons.org/licenses/by-nc-sa/4.0 target=_blank rel="noopener nofollow">CC BY-NC-SA 4.0</a> 许可协议。完整转载请注明来自 <a href=https://astro-blog.boycot.top>boycot</a>！</p><svg viewBox="0 0 496 512" xmlns=http://www.w3.org/2000/svg><path d="M245.8 214.9l-33.2 17.3c-9.4-19.6-25.2-19.9-27.5-19.9-22.1 0-33.2 14.6-33.2 43.8 0 23.6 9.2 43.8 33.2 43.8 14.5 0 24.7-7.1 30.6-21.3l30.6 15.5c-6.2 11.5-25.7 39-65.1 39-22.6 0-74-10.3-74-77.1 0-58.7 43-77.1 72.6-77.1 30.7 0 52.7 12 66 35.9zm143.1 0l-32.8 17.3c-9.5-19.8-25.7-19.9-27.9-19.9-22.1 0-33.2 14.6-33.2 43.8 0 23.6 9.2 43.8 33.2 43.8 14.5 0 24.7-7.1 30.5-21.3l31 15.5c-2.1 3.8-21.4 39-65.1 39-22.7 0-74-9.9-74-77.1 0-58.7 43-77.1 72.6-77.1 30.7 0 52.6 12 65.6 35.9zM247.6 8.1C104.7 8.1 0 123.1 0 256.1c0 138.5 113.6 248 247.6 248 129.9 0 248.4-100.9 248.4-248 0-137.9-106.6-248-248.4-248zm.9 450.8c-112.5 0-203.7-93-203.7-202.8 0-105.4 85.4-203.3 203.7-203.3 112.5 0 202.8 89.5 202.8 203.3 0 121.7-99.7 202.8-202.8 202.8z"></path></svg></section></footer><section class=byt-comment><section><section class=byt-space-loading><span></span><span></span><span></span></section></section></section></article></section><aside class=byt-aside><section class="byt-aside-item user"><img alt=boycot src=/assets/images/lazy-loading.webp data-byt-lz-src=https://boycot2015.github.io/picx-images-hosting/avatar/avatar.7pnvyzg2f.webp class=byt-aside-avatar> <span class=byt-aside-auther>boycot</span><p class=byt-aside-motto>越努力越幸运.</p><section class=byt-aside-links><a href=https://github.com/boycot2015 target=_blank class=byt-aside-links-item rel="noopener nofollow" title=Github><svg viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=3 class="icon icon-tabler icons-tabler-outline icon-tabler-brand-github"><path d="M0 0h24v24H0z" fill=none stroke=none /><path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5"/></svg> </a><a href=https://api.boycot.top target=_blank class=byt-aside-links-item rel="noopener nofollow" title=boycotAPI><svg viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 height=24 width=24 class="icon icon-tabler icons-tabler-outline icon-tabler-api"><path d="M0 0h24v24H0z" fill=none stroke=none /><path d="M4 13h5"/><path d="M12 16v-8h3a2 2 0 0 1 2 2v1a2 2 0 0 1 -2 2h-3"/><path d="M20 8v8"/><path d="M9 16v-5.5a2.5 2.5 0 0 0 -5 0v5.5"/></svg> </a><a href=https://news.boycot.top target=_blank class=byt-aside-links-item rel="noopener nofollow" title=每日热榜><svg viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 height=24 width=24 class="icon icon-tabler icons-tabler-outline icon-tabler-brand-tinder"><path d="M0 0h24v24H0z" fill=none stroke=none /><path d="M18.918 8.174c2.56 4.982 .501 11.656 -5.38 12.626c-7.702 1.687 -12.84 -7.716 -7.054 -13.229c.309 -.305 1.161 -1.095 1.516 -1.349c0 .528 .27 3.475 1 3.167c3 0 4 -4.222 3.587 -7.389c2.7 1.411 4.987 3.376 6.331 6.174z"/></svg></a></section><section class=byt-aside-info><div class="count art-item"><span>38</span><p>文章数</p></div><div class="count cat-item"><span>16</span><p>分类数</p></div><div class="count tag-item"><span>24</span><p>标签数</p></div></section><canvas class=byt-aside-canvas height=1888 width=888></canvas></section><section class="byt-aside-item tips"><span><svg viewBox="0 0 24 24" xmlns=http://www.w3.org/2000/svg fill=none stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2><path d="M0 0h24v24H0z" fill=none stroke=none></path><path d="M3 9.662c2 2.338 2 4.338 0 6.338c3 .5 4.5 1 5 4c2 -3 6 -4 9 0c0 -3 1 -4 4 -4.004q -3 -2.995 0 -5.996c-3 0 -5 -2 -5 -5c-2 4 -5 3 -7.5 -1c-.5 3 -2.5 5 -5.5 5.662"></path></svg> 公告</span><div class=tips-content><p>欢迎光临我的博客 🎉</p><p>这里会分享我的日常和学习中的收集、整理及总结，希望能对你有所帮助:) 💖</p></div></section><section class="byt-aside-item cat"><h3>分类</h3><div class=byt-aside-cat><a href=/categories/框架><span>框架</span> <i>4</i> </a><a href=/categories/游戏><span>游戏</span> <i>2</i> </a><a href=/categories/php><span>php</span> <i>1</i> </a><a href=/categories/css><span>css</span> <i>1</i> </a><a href=/categories/equb.js><span>equb.js</span> <i>1</i> </a><a href=/categories/阅读><span>阅读</span> <i>1</i> </a><a href=/categories/ai><span>ai</span> <i>1</i> </a><a href=/categories/typecho><span>typecho</span> <i>1</i> </a><a href=/categories/hexo主题><span>hexo主题</span> <i>1</i> </a><a href=/categories/Nodejs><span>Nodejs</span> <i>1</i> </a><a href=/categories/ssh><span>ssh</span> <i>1</i> </a><a href=/categories/element-plus主题><span>element-plus主题</span> <i>1</i> </a><a href=/categories/工具><span>工具</span> <i>1</i> </a><a href=/categories/astrojs><span>astrojs</span> <i>1</i> </a><a href=/categories/魅族><span>魅族</span> <i>1</i> </a><a href=/categories/动画><span>动画</span> <i>1</i></a></div></section><section class="byt-aside-item tags"><h3>热门标签</h3><div class=byt-aside-tags><a href=/tag/javascript><span>javascript</span> <em>5</em> </a><a href=/tag/astro><span>astro</span> <em>3</em> </a><a href=/tag/ai><span>ai</span> <em>2</em> </a><a href=/tag/游戏><span>游戏</span> <em>2</em> </a><a href=/tag/php><span>php</span> <em>1</em> </a><a href=/tag/css><span>css</span> <em>1</em> </a><a href=/tag/ellipsis><span>ellipsis</span> <em>1</em> </a><a href=/tag/equb.js><span>equb.js</span> <em>1</em> </a><a href=/tag/NestJS><span>NestJS</span> <em>1</em> </a><a href=/tag/NuxtJS><span>NuxtJS</span> <em>1</em> </a><a href=/tag/NextJS><span>NextJS</span> <em>1</em> </a><a href=/tag/aplayer><span>aplayer</span> <em>1</em> </a><a href=/tag/Typecho><span>Typecho</span> <em>1</em> </a><a href=/tag/hexo><span>hexo</span> <em>1</em> </a><a href=/tag/Node><span>Node</span> <em>1</em> </a><a href=/tag/ssh><span>ssh</span> <em>1</em> </a><a href=/tag/element-plus><span>element-plus</span> <em>1</em> </a><a href=/tag/主题><span>主题</span> <em>1</em> </a><a href=/tag/vue3><span>vue3</span> <em>1</em> </a><a href=/tag/魅族21><span>魅族21</span> <em>1</em> </a><a href=/tag/动画><span>动画</span> <em>1</em> </a><a href=/tag/element-ui><span>element-ui</span> <em>1</em> </a><a href=/tag/test><span>test</span> <em>1</em> </a><a href=/tag/markdown><span>markdown</span> <em>1</em></a></div></section><section class=sticky-aside><section class="byt-aside-item articles"><h3>推荐文章</h3><div class=byt-aside-articles><a href=/article/本地php环境安装><span><i>1</i> <cite class=byt-ellipsis>本地php环境安装</cite> </span><time>2025-03-12 中午</time> </a><a href=/article/css文本超出一定范围后显示省略号><span><i>2</i> <cite class=byt-ellipsis>css文本超出一定范围后显示省略号</cite> </span><time>2025-03-11 凌晨</time> </a><a href=/article/使用epub.js解析epub文件><span><i>3</i> <cite class=byt-ellipsis>使用epub.js解析epub文件</cite> </span><time>2025-02-25 中午</time> </a><a href=/article/《毛概》读后感><span><em>4.</em> <cite class=byt-ellipsis>《毛概》读后感</cite> </span><time>2025-02-17 下午</time> </a><a href=/article/NestJS入门指南><span><em>5.</em> <cite class=byt-ellipsis>NestJS入门指南</cite> </span><time>2025-02-17 凌晨</time> </a><a href=/article/js实现俄罗斯方块><span><em>6.</em> <cite class=byt-ellipsis>js实现俄罗斯方块</cite> </span><time>2025-02-17 凌晨</time></a></div></section></section></aside></section><section class=byt-back-top><svg viewBox="0 0 24 24"><defs><linearGradient id=Gradient x1=0% x2=100% y1=0% y2=0%><stop offset=0% style=stop-color:blue;stop-opacity:1></stop><stop offset=50% style=stop-color:violet;stop-opacity:1></stop><stop offset=100% style=stop-color:indigo;stop-opacity:1></stop></linearGradient></defs><circle cx=12 cy=12 fill=none r=10 stroke=url(#Gradient) stroke-linecap=round stroke-width=2 transform="rotate(-90, 12, 12)"></circle></svg> <svg viewBox="0 0 24 24" class=icon><path d="m6 15l6-6l6 6" fill=none stroke=#000 stroke-linecap=round stroke-linejoin=round stroke-width=2></path></svg></section></main><footer class=byt-footer><main><p></p><p><span><svg viewBox="0 0 512 512" xmlns=http://www.w3.org/2000/svg><path d="M269.4 2.9C265.2 1 260.7 0 256 0s-9.2 1-13.4 2.9L54.3 82.8c-22 9.3-38.4 31-38.3 57.2c.5 99.2 41.3 280.7 213.6 363.2c16.7 8 36.1 8 52.8 0C454.7 420.7 495.5 239.2 496 140c.1-26.2-16.3-47.9-38.3-57.2L269.4 2.9zM144 221.3c0-33.8 27.4-61.3 61.3-61.3c16.2 0 31.8 6.5 43.3 17.9l7.4 7.4 7.4-7.4c11.5-11.5 27.1-17.9 43.3-17.9c33.8 0 61.3 27.4 61.3 61.3c0 16.2-6.5 31.8-17.9 43.3l-82.7 82.7c-6.2 6.2-16.4 6.2-22.6 0l-82.7-82.7c-11.5-11.5-17.9-27.1-17.9-43.3z" fill=#fff></path></svg><cite>稳定运行</cite><em class=web_time></em></span><a href=https://astro.build/ target=_blank rel="noopener noreferrer"><img alt=Astro src=/assets/images/footer/astro.svg></a><a href=https://github.com/uxiaohan/bytAstro-Theme target=_blank rel="noopener noreferrer"><img alt=bytAstro-Theme src=/assets/images/footer/theme.svg></a><a href=/sitemap-index.xml target=_blank><img alt=sitemap src=/assets/images/footer/sitemap.svg></a><a href=/rss.xml target=_blank><img alt=rss src=/assets/images/footer/rss.svg></a><a href=https://beian.miit.gov.cn/ target=_blank rel="noopener noreferrer"><img alt=粤ICP备18002072号 src=https://img.shields.io/badge/%E7%B2%A4ICP%E5%A4%87-18002072%E5%8F%B7-red></a></p></main></footer><script src=/js/Layout.astro_astro_type_script_index_0_lang-DgTlPAyi.js type=module></script></body></html>