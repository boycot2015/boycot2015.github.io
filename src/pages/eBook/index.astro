---
import Layout from "@/layouts/ToolLayout/ToolLayout.astro";
import { getAllbooks } from "@/data/ebook";
const allbooks = await getAllbooks()

const meta = {
    type: 'eBook',
	description: "ÊàëÊúÄËøëÂú®ÈòÖËØªÁöÑÁîµÂ≠ê‰π¶ÔºåÊÑüÂÖ¥Ë∂£ÁöÑÊúãÂèãÂèØ‰ª•‰∏éÊàë‰∏ÄËµ∑ÂàÜ‰∫´",
	title: "ÁîµÂ≠ê‰π¶ üìñ",
};
// console.log(allbooks, 'allbooks');
const data = allbooks.map(el => el.data)
const isPro = import.meta.env.PROD
---

<Layout frontmatter={meta}>
    {data.length === 0 ? <section class="byt-space-loading absolute"><span></span><span></span><span></span></section> : null}
    <!-- <h1 transition:name={`title`} transition:animate={`slide`} class="title mb-6 flex items-center gap-3">ÁîµÂ≠ê‰π¶</h1> -->
    <div id="books" class="books grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        {
            data.map((item, index) => <div id={`book${index+1}`} data-id={item.objectId} class="book-item rounded overflow-hidden bg-[var(--byt-white-color)] shadow-[var(--byt-box-shadow)]"><a href={'/eBook/'+item.title}><div class={`w-full  overflow-hidden`}  title={`${item.title}-${item.author}`}>
            <img transition:name={`img-${item.title}-${item.author}`} data-byt-lz-src={item.img} class="h-[230px] sm:h-[260px] w-full" alt={item.title} />
            <h3 transition:name={`title-${item.title}`} class="text-center !text-sm !line-clamp-1 mt-2">{item.title}-{item.author.split('.')[0]}</h3></div></a>
            {!isPro ? <div class="flex justify-center my-1"><button class="remove-btn border px-1 rounded-md text-[var(--byt-main-color)] border-[var(--byt-main-color)] cursor-pointer" data-object-id={item.objectId} data-id={`book${index+1}`}>Âà†Èô§</button></div> : null}
            </div>)
        }
        {
            !isPro ? <div class="add-btn cursor-pointer border rounded-md bg-[var(--byt-white-color)] border-[var(--byt-main-color)] px-10 text-[40px] w-[auto] justify-center items-center flex flex-col h-[320px] sm:h-[360px] text-[var(--byt-main-color)]">
                +
                <span class="text-xl">‰∏ä‰º†</span>
                <input type="file" accept=".epub,.txt" hidden />
            </div> : null
        }
    </div>
</Layout>
<script>
    import { inRouter } from '@/utils/updateRouter'
    import { handleDelete, upload, update } from '@/api/book'
    import localforage from 'localforage'
    import Epub from 'epubjs'
    import loadingService from '@/utils/Loading'
    import { Toast } from '@/utils/Toast'
    import Sortable from 'sortablejs'
    // ÂõæÁâáÊáíÂä†ËΩΩ
    import LzImgInit from "@/scripts/LazyImg";
    let targetEl = document.querySelector('.add-btn') as HTMLDivElement
    let fileEl = document.querySelector('#books input') as HTMLInputElement
    let bookEl = document.querySelector('#books') as HTMLDivElement
    // ÂàùÂßãÂåñ SortableJS
    if (!import.meta.env.PROD && bookEl) {
        Sortable.create(bookEl, {
            animation: 150,
            draggable: ".book-item",
            onEnd: async () => {
                const items = Array.from(bookEl.children).map((el: any) => el.getAttribute('data-id')).filter(el => !!el);
                try {
                    await Promise.all(items.map((el, index) => update(el, { order: index + 1 })));
                    Toast('ÊéíÂ∫èÂ∑≤‰øùÂ≠òÔºÅ');
                } catch (error) {
                    Toast('‰øùÂ≠òÊéíÂ∫èÂ§±Ë¥•ÔºåËØ∑ÈáçËØïÔºÅ');
                }
            }
        });
    }

    targetEl && (targetEl.onclick = () => {
        fileEl.click()
    })
    let loading = loadingService(bookEl)
    // loading.show({precent: 0})
    bookEl && bookEl.addEventListener('click', (e:any) => {
        // console.log(e.target.tagName, 'e.target.tagName');
        if (e.target.tagName === 'BUTTON') {
            let target = e.target
            let id = target.getAttribute('data-id')
            let objectId = target.getAttribute('data-object-id')
            loading.show({})
            if (objectId) handleDelete(objectId).then(() => {
                loading.hide()
                Toast('Âà†Èô§ÊàêÂäüÔºÅ')
                document.querySelector(`#${id}`)?.remove()
            })
        }
    })
    fileEl && (fileEl.onchange = (e: Event) => {
        let target = e.target as any
        let files = [...target.files]
        files.map(async el => {
            let book:any = Epub(el);
            book.ready.then(async () => {
                loading.show({})
                let coverUrl = await book.coverUrl()
                let result = await fetch(coverUrl).then(res => res.blob())
                let reader = new FileReader()
                reader.readAsDataURL(result)
                reader.onload = () => {
                    loading.show({precent: 0})
                    upload(el.name, el, {cover: { base64: reader.result }, onprogress: (data:any) => {
                        // loading.onprogress(data)
                        loading.show({precent: data.percent.toFixed(2)})
                    }}).then((data:any) => {
                        const { attributes, id } = data
                        // console.log(attributes, 'data');
                        let alink = document.createElement('div') as HTMLDivElement
                        let removeBtnEl = bookEl.querySelectorAll('.remove-btn')
                        alink.id = `book${removeBtnEl.length+1}`
                        alink.setAttribute('class', 'book-item bg-[var(--byt-white-color)] w-full overflow-hidden rounded shadow-[var(--byt-box-shadow)]')
                        alink.innerHTML = `<a href='/eBook/${el.name.split('_')[0]}'><div class='w-full  overflow-hidden'  title='${attributes.title}'>
                        <img data-byt-lz-src='${attributes.img.replace('dailynote', 'blog-cloud')}' class="h-[230px] sm:h-[260px] w-full" alt={item.title} />
                        <h3 class="text-center !text-sm !line-clamp-1 mt-2">${el.name.split('_')[0]}-${el.name.split('_')[1]}</h3></div></a><div class="flex justify-center my-1"><button class="remove-btn border px-1 rounded-md text-[var(--byt-main-color)] border-[var(--byt-main-color)] cursor-pointer" data-object-id=${id} data-id="book${removeBtnEl.length+1}">Âà†Èô§</button></div>`
                        bookEl.prepend(alink)
                        localforage.setItem('book_' + el.name, el.arrayBuffer())
                        Toast('‰∏ä‰º†ÊàêÂäüÔºÅ')
                        fileEl.value = ''
                        loading.hide()
                        LzImgInit()
                    })
                }
            })
        })
    })
    const ebookMainEl = document.querySelector('.main-inner-content>.byt-tools-main>main.ebook-main')
    if (ebookMainEl) ebookMainEl.innerHTML = ''
    inRouter(() => {
        if (ebookMainEl) ebookMainEl.innerHTML = ''
    })
</script>
