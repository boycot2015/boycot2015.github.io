---
import { getDescription, fmtTime } from "@/utils/index";
import { type CollectionEntry, getCollection } from "astro:content";
import { render } from "astro:content";
export async function getStaticPaths() {
	const posts = await getCollection("blog");
	return posts.map((post: any) => ({ params: { article: post.data.id || post.data.title }, props: post }));
}
// 处理文章内容
type Props = CollectionEntry<"blog">;
const post: any = Astro.props;
// 获取封面图
import getCover from "@/utils/getCover";
const ARTICLE_COVER: string = await getCover(post.data.cover);
// 页面 Info
import SITE_CONFIG from "@/config";
const { Site, Title, Author, GoogleAds, HomeBanner } = SITE_CONFIG;
// 处理文章内容
const description = getDescription(post);
const { Content, remarkPluginFrontmatter } = await render(post);
// 文章字数和阅读时间
const { reading_time, article_word_count } = remarkPluginFrontmatter;
// 公共 Layout
import Layout from "@/layouts/Layout/Layout.astro";
// Copyright 组件
import Copyright from "@/components/Copyright/Copyright.astro";
// Reward 组件
import Reward from "@/components/Reward/Reward.astro";
// 评论组件
import { checkComment } from "@/scripts/Comment";
import Comment from "@/components/Comment/Comment.astro";
// Google 广告组件
import GoogleAd from "@/components/GoogleAd/GoogleAd.astro";
// Aside组件
// import Aside from "@/components/Aside/Aside.astro";
// 文章页面样式
import "@/styles/Article.less";
// 文章内容基础样式
import "@/styles/ArticleBase.less";
const { headings } = await render(post);

---

<Layout title={post.data.title} keywords={post.data.tags} description={description} pagecover={ARTICLE_COVER} headings={headings} activeNav="article">
	<article class="byt-article-main byt-animation byt-animation-init main-inner">
		<div class="main-inner-content">
			<header>
				<h1>{post.data.title}</h1>
				<div class="article-meta">
					<span class="article-meta-item">
						<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path><path d="M12 12h3.5"></path><path d="M12 7v5"></path></svg>
						<time>{fmtTime(post.data.date, "YYYY-MM-DD A")}</time>
						<span class="count"><strong>{article_word_count || "一点"}</strong>字</span>
						<span class="time"><strong>{parseFloat((Number(reading_time) || 0).toFixed(1).replace(/\.0+$/, ""))}</strong>分钟</span>
					</span>
					<a class="article-meta-item" href={`/categories/${post.data.categories}`}>
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path d="M4 6h16"></path><path d="M7 12h13"></path><path d="M10 18h10"></path></svg>
						<span>{post.data.categories}</span>
					</a>
				</div>
			</header>
			<main>
				<!-- ai 生成的内容 文章概要：-->
				<div id="ai-content-sum" class="bg-[var(--byt-code-bg)] rounded-xl overflow-hidden clear-both p-2 my-2">
					<section class="byt-space-loading !h-[2.88rem]"><span></span><span></span><span></span></section>
				</div>
				<!-- 音乐组件 -->
				{post.data.music && <div class="byt-node byt-music" data-config={JSON.stringify({ type: post.data.music?.type, server: post.data.music?.server, id: post.data.music?.id })}></div>}
				<Content />
				<section class="tag-list">
					{
						(post.data.tags || []).map((i: any) => (
							<a href={`/tag/${i}`}>
								<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
									<path stroke="none" d="M0 0h24v24H0z" fill="none" />
									<path d="M7.5 7.5m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" />
									<path d="M3 6v5.172a2 2 0 0 0 .586 1.414l7.71 7.71a2.41 2.41 0 0 0 3.408 0l5.592 -5.592a2.41 2.41 0 0 0 0 -3.408l-7.71 -7.71a2 2 0 0 0 -1.414 -.586h-5.172a3 3 0 0 0 -3 3z" />
								</svg>
								{i}
							</a>
						))
					}
				</section>
			</main>
			<footer>
				<!-- 打赏组件 -->
				{SITE_CONFIG.Reward && (SITE_CONFIG.Reward.AliPay || SITE_CONFIG.Reward.WeChat) && <Reward />}
				<!-- 版权©️信息 -->
				<Copyright site={Site} id={post.data.id} title={post.data.title} sitename={Title} time={fmtTime(post.data.date, "YYYY-MM-DD A")} auther={Author} />
				<!-- 底部谷歌广告 -->
				{GoogleAds.ad_Client && GoogleAds.articleAD_Slot && <GoogleAd className="byt-article-ad" slotID={GoogleAds.articleAD_Slot} />}
			</footer>
			{checkComment() && <Comment />}
			<astro-anchor data-post={JSON.stringify(post)}></astro-anchor>
		</div>
	</article>
	<script>
		import Anchor from "@/scripts/Anchor";
		class AstroAnchor extends HTMLElement {
		  async connectedCallback() {
			// 从 data（数据）属性中读取消息。
			const post = JSON.parse(this.dataset.post as string);
			Anchor(post)
			let aiContentSum = document.getElementById("ai-content-sum");
			await fetch("http://api-ai.boycot.dpdns.org/api/llm", {
				method: "POST",
				body: JSON.stringify({
					messages: [
						{
							role: "user",
							content: `请根据文章内容：${post.body}, 简单总结一下文章的内容，不超过150个字符`
						}
					]
				})
			}).then(res => res.json()).then(data => {
				if (aiContentSum) {
					aiContentSum.innerHTML = `<span class="float-left mr-2 text-[var(--byt-main-color)]">
							<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 48 48">
							<path fill="currentColor" fill-rule="evenodd" d="M34.307 1.884c.948-1.733 3.438-1.733 4.386 0l1.992 3.642a4.5 4.5 0 0 0 1.789 1.789l3.642 1.992c1.733.948 1.733 3.438 0 4.386l-3.642 1.992a4.5 4.5 0 0 0-1.789 1.789l-1.992 3.642c-.948 1.733-3.438 1.733-4.386 0l-1.992-3.642a4.5 4.5 0 0 0-1.789-1.789l-3.642-1.992c-1.733-.948-1.733-3.438 0-4.386l3.642-1.992a4.5 4.5 0 0 0 1.789-1.789zm-5.91 3.176l-2.952 1.615c-3.815 2.086-3.815 7.564 0 9.65l3.642 1.992a1.5 1.5 0 0 1 .596.596l1.992 3.642c1.13 2.067 3.256 3.014 5.3 2.84a18.5 18.5 0 0 1-6.503 10.12a75 75 0 0 1-.526 1.788c-.47 1.534-1.775 2.709-3.452 2.884c-1.453.151-3.855.313-7.494.313s-6.041-.162-7.494-.313c-1.677-.175-2.981-1.35-3.452-2.884a75 75 0 0 1-.526-1.788C3.25 32.129.5 26.885.5 21C.5 10.783 8.783 2.5 19 2.5c3.43 0 6.642.934 9.396 2.56M10.447 42.54q.39.09.798.133c1.552.162 4.042.327 7.754.327s6.201-.165 7.754-.327a6.6 6.6 0 0 0 1.053-.197l-.032.3c-.235 2.165-1.787 4.127-4.163 4.44a36 36 0 0 1-4.612.284c-1.97 0-3.499-.142-4.622-.312c-2.067-.313-3.428-1.955-3.773-3.797q-.075-.399-.157-.85" clip-rule="evenodd"/></svg>
						</span>
						<span>${data.data.response}</span>`;
				}
			});
		  }
		}
		customElements.define('astro-anchor', AstroAnchor);
	</script>
</Layout>