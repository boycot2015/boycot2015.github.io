import{e as u}from"../_astro/epubjs.DksIVjnn.js";import"../_astro/vendor.t3tUpFQ-.js";import{l}from"../_astro/localforage.WJDvAe_L.js";import{b as g,l as v}from"../_astro/Loading.GowfwsGL.js";import"../_astro/lodash.CgCKa2MW.js";import"../_astro/aplayer.Be6-aBBk.js";import"../_astro/jszip.C3unUf8N.js";import"../_astro/leancloud-storage.CjrZWAQ1.js";const m={book:g};class f extends HTMLElement{data;book;themes;fontSize=16;rendition;bookmarks=[];columns=[];columnsEl;marksEl;actionEl;booksmarksPanel;connectedCallback(){this.init()}async init(){const t=document.getElementById("book"),e=document.getElementById("books");let o=v(t);t&&o.show();const a=JSON.parse(this.dataset.book);e&&(e.value=a.id);let s=await l.getItem("book_"+a.data.title),i=await l.getItem("book_marks_"+a.data.title)||[],r=await l.getItem("book_current_page_"+a.data.title)||"";if(!s){let t=await fetch(a.data.file).then((t=>t.arrayBuffer()));l.setItem("book_"+a.data.title,t),s=t}let n=u(s);n.ready.then((()=>{t.innerHTML="";const e=n.renderTo(t,{flow:"paginated",width:"100%",height:"100%",stylesheet:"../../../assets/css/global.css",spread:!0,minSpreadWidth:1200,allowScriptedContent:!0});this.data=a,this.book=n,this.rendition=e,this.bookmarks=i,this.themes=e.themes,this.registerTheme(),this.loadColumns(),this.loadMarks(),this.jumpTo(r||i[0]?.start?.cfi||2);let s=this.querySelector(".btn-prev"),l=this.querySelector(".btn-next"),h=this.querySelector(".pager"),m=this.querySelector(".add-label-btn");s.onclick=()=>this.pageChange(),l.onclick=()=>this.pageChange("next"),h.onblur=()=>this.pageChange("pager"),m.onclick=()=>this.addMark(),this.columnsEl.onchange=t=>this.columnsChange(t),this.marksEl.onchange=t=>this.changeMark(t.target),t&&o.hide()})),e&&(e.onchange=t=>{window.location.href="/eBook/"+t.target.value})}getThemeList(){return[{name:"default",style:{body:{padding:"0 !important",background:"transparent !important",lineColor:"#E4E3DF"},"body, p, h1, h2, h3, h4, h5, h6, b":{"line-height":"2.28rem !important","font-size":"1.28rem !important","font-family":"CangErYuYang !important"},".logo":{display:"none"}}},{name:"twoTheme",style:{body:{color:"#39342B",background:"#D5C6A9",lineColor:"#C6B89B"}}},{name:"threeTheme",style:{body:{color:"#94938F",background:"#3A3031",lineColor:"#3F3939"}}},{name:"fourTheme",style:{body:{color:"#313635",background:"#CCE8D1",lineColor:"#BCD8C1"}}},{name:"fiveTheme",style:{body:{color:"rgb(100,110,119)",background:"#051827",lineColor:"#0C1E2D"}}}]}loadColumns(){let t=this.querySelector("#columns"),e=this.book.navigation.toc;const o=(t,e)=>(t.map((({subitems:t,...a})=>{e.push((t=>({...t,href:(""+t.href).replace(/(?!^)#.*/,""),label:t.label?.replace(/\n/g,"").split(" ").filter((t=>t)).slice(-2).join(" ")}))({...a})),t?.length&&e.concat(o(t,e))})),e);e=o(e,[]),e.filter((t=>t.href)).map((e=>{let o=document.createElement("option");o.label=e.label,o.value=e.href,t.appendChild(o)})),t.value=this.bookmarks[0]?.start.href||"",this.columns=e,this.columnsEl=t}loadMarks(){let t=this.querySelector("#marks");t.innerHTML='<option label="请选择"></option>',this.bookmarks.filter((t=>t.label)).map((e=>{let o=document.createElement("option");o.label=e.label,o.value=e.start.cfi,t.appendChild(o)})),this.bookmarks.length&&t.value&&this.changeMark(t),this.marksEl=t,this.renderBookMarksPanel()}registerTheme(){this.getThemeList().map((t=>{this.themes.register(t.name,t.style)}))}setTheme(t){this.themes.fontSize(this.fontSize+"px"),this.themes.select(this.getThemeList()[t]?.name)}addMark(){let t={...this.rendition.location,label:this.columns.find((t=>t.href.split("#")[0]===this.rendition.location.start?.href))?.label+"_"+this.rendition.location.start?.displayed.page},e=this.bookmarks.find((e=>e.label===t.label));if(!e){this.bookmarks.unshift(t);let e=document.createElement("option");e.label=t.label,e.value=t.start.cfi,this.marksEl.appendChild(e),l.setItem("book_marks_"+this.data.data.title,this.bookmarks),this.data.objectId&&m.book.saveMark(this.data.objectId,this.bookmarks),this.renderBookMarksPanel()}window.BMessage.open({content:e?"书签已存在":"添加成功",type:e?"warning":"success"})}changeMark(t){if(!t.value)return;this.jumpTo(t.value||"");let e=this.bookmarks.find((e=>e.start.cfi===t.value)),o=this.bookmarks.findIndex((e=>e.start.cfi===t.value)),a=this.bookmarks[0];e&&(this.bookmarks.splice(0,1,e),this.bookmarks.splice(o,1,a),l.setItem("book_marks_"+this.data.data.title,this.bookmarks),this.columnsEl.value=e.start.href||"",this.toTop())}pageChange(t="prev"){let e=this.querySelector(".pager");if("pager"===t)return e.value&&(this.jumpTo(e.value),this.toTop()),void(e.value="");this.marksEl.value="",this.jumpTo("",t),this.toTop()}columnsChange(t){let e=t.target;this.marksEl.value="",this.jumpTo(e.value||""),this.toTop()}toTop(){document.body.scrollIntoView({behavior:"smooth"})}jumpTo(t,e="display"){this.rendition[e](t||"").then((t=>{let e=this.rendition.location;this.columnsEl.value=t?.href||e.start?.href,e&&l.setItem("book_current_page_"+this.data.data.title,e.start?.cfi||"")}))}deleteBookmark(t){this.bookmarks.splice(t,1),l.setItem("book_marks_"+this.data.data.title,this.bookmarks),this.data.objectId&&m.book.saveMark(this.data.objectId,this.bookmarks),window.BMessage.open({content:"删除成功",type:"success"}),this.loadMarks()}clearBookmarks(){this.bookmarks=[],l.setItem("book_marks_"+this.data.data.title,this.bookmarks),this.data.objectId&&m.book.saveMark(this.data.objectId,this.bookmarks),window.BMessage.open({content:"清空成功",type:"success"}),this.loadMarks()}renderBookMarksPanel(){if(this.actionEl=document.querySelector(".manager-btn"),this.booksmarksPanel=document.querySelector(".booksmarks-panel"),this.actionEl?.addEventListener("click",(t=>{t.preventDefault(),this.booksmarksPanel?.classList.remove("hidden")})),this.booksmarksPanel){let t='<div class="pb-1 rounded-md bg-[var(--byt-white-color)] "><div class="flex border-b border-[var(--byt-main-color)] p-2 mb-2">\n\t\t\t\t\t\t\t<span class="flex-2">书签管理</span>\n\t\t\t\t\t\t\t<span class="flex items-center cursor-pointer hover:text-[var(--byt-main-color)] clear-btn">\n\t\t\t\t\t\t\t\t清空\n\t\t\t\t\t\t\t\t<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="currentColor" d="M7 21q-.825 0-1.412-.587T5 19V6H4V4h5V3h6v1h5v2h-1v13q0 .825-.587 1.413T17 21zM17 6H7v13h10zM9 17h2V8H9zm4 0h2V8h-2zM7 6v13z"/></svg>\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</div><div class="max-h-30 overflow-y-auto mb-2 px-2 space-y-2 !bg-[var(--byt-white-color)]">';this.booksmarksPanel.innerHTML=t+this.bookmarks.map(((t,e)=>`<div class="flex items-center">\n\t\t\t\t\t\t<span class="flex-2 line-clamp-1">${t.label}</span>\n\t\t\t\t\t\t<svg class="del-btn cursor-pointer hover:text-[var(--byt-main-color)]" data-index="${e}" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">\x3c!-- Icon from Material Symbols by Google - https://github.com/google/material-design-icons/blob/master/LICENSE --\x3e<path fill="currentColor" d="M6.4 19L5 17.6l5.6-5.6L5 6.4L6.4 5l5.6 5.6L17.6 5L19 6.4L13.4 12l5.6 5.6l-1.4 1.4l-5.6-5.6z"/></svg>\n\t\t\t\t\t</div>`)).join("")+"</div></div>"}this.actionEl?.classList[this.bookmarks.length?"remove":"add"]("hidden"),document.addEventListener("click",(t=>{this.actionEl?.contains(t.target)||this.booksmarksPanel?.classList.add("hidden")}));let t=this.booksmarksPanel?.querySelectorAll(".del-btn")||[],e=this.booksmarksPanel?.querySelector(".clear-btn");for(let e=0;e<t.length;e++)t[e]?.addEventListener("click",(t=>{let e=t.target.getAttribute("data-index")||"0";this.deleteBookmark(parseInt(e))}));e?.addEventListener("click",(()=>{this.clearBookmarks()}))}}customElements.define("book-component",f);